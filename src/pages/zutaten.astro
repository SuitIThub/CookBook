---
export const prerender = false;
import Layout from '../layouts/Layout.astro';
import RecipesModal from '../components/modals/RecipesModal.astro';
import MergeSuggestionsModal from '../components/modals/MergeSuggestionsModal.astro';
import { db } from '../lib/database';

// Load all ingredients from database
let ingredients: Array<{ name: string; usageCount: number }> = [];
try {
  ingredients = db.getAllIngredientsFromRecipes();
} catch (error) {
  console.error('Error loading ingredients:', error);
}
---

<Layout title="Zutaten">
  <div class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-6">
      <div>
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Zutaten</h1>
        <p class="text-gray-600 dark:text-gray-400">
          Verwalten und vereinheitlichen Sie Zutaten aus allen Rezepten
        </p>
      </div>
      <div class="text-sm text-gray-500 dark:text-gray-400">
        {ingredients.length} {ingredients.length === 1 ? 'Zutat' : 'Zutaten'}
      </div>
    </div>

    <!-- Search bar and merge button -->
    <div class="mb-6 flex items-center space-x-3">
      <input
        type="text"
        id="ingredient-search"
        placeholder="Zutaten suchen..."
        class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-orange-500"
      />
      <button
        id="merge-suggestions-btn"
        class="px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg transition-colors text-sm font-medium whitespace-nowrap"
      >
        Zusammenführungsvorschläge
      </button>
    </div>

    <!-- Ingredients list -->
    <div id="ingredients-list" class="space-y-2">
      {ingredients.map((ingredient) => (
        <div
          class="ingredient-item flex items-center justify-between p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 hover:shadow-md transition-shadow"
          data-ingredient-name={ingredient.name.toLowerCase()}
        >
          <div class="flex items-center space-x-4 flex-1">
            <span class="font-medium text-gray-900 dark:text-white">{ingredient.name}</span>
            <span class="text-sm text-gray-500 dark:text-gray-400">
              ({ingredient.usageCount} {ingredient.usageCount === 1 ? 'Rezept' : 'Rezepte'})
            </span>
          </div>
          <div class="flex items-center space-x-2">
            <button
              class="recipes-btn px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors text-sm font-medium"
              data-ingredient-name={ingredient.name}
            >
              Rezepte
            </button>
            <button
              class="rename-btn px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors text-sm font-medium"
              data-ingredient-name={ingredient.name}
            >
              Umbenennen
            </button>
            <button
              class="unify-btn px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg transition-colors text-sm font-medium"
              data-ingredient-name={ingredient.name}
            >
              Vereinheitlichen
            </button>
          </div>
        </div>
      ))}
    </div>

    {ingredients.length === 0 && (
      <div class="text-center py-12">
        <p class="text-gray-500 dark:text-gray-400">Keine Zutaten gefunden.</p>
      </div>
    )}
  </div>

  <RecipesModal />
  <MergeSuggestionsModal />

  <!-- Rename Modal -->
  <div
    id="rename-modal"
    class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
  >
    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4">
      <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
        Zutat umbenennen
      </h2>
      <p class="text-gray-600 dark:text-gray-400 mb-4">
        Geben Sie den neuen Namen für "<span id="rename-old-ingredient-name" class="font-semibold"></span>" ein:
      </p>
      <div class="mb-4">
        <input
          type="text"
          id="rename-new-ingredient-input"
          placeholder="Neuer Zutatenname..."
          class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
        />
      </div>
      <div class="flex justify-end space-x-3">
        <button
          id="cancel-rename-btn"
          class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
        >
          Abbrechen
        </button>
        <button
          id="confirm-rename-btn"
          class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors"
        >
          Umbenennen
        </button>
      </div>
    </div>
  </div>

  <!-- Unify Modal -->
  <div
    id="unify-modal"
    class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
  >
    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4">
      <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
        Zutat vereinheitlichen
      </h2>
      <p class="text-gray-600 dark:text-gray-400 mb-4">
        Wählen Sie die Zutat, mit der "<span id="old-ingredient-name" class="font-semibold"></span>" vereinheitlicht werden soll:
      </p>
      <div class="mb-4 relative">
        <div class="relative">
          <input
            type="text"
            id="new-ingredient-input"
            placeholder="Zutat eingeben oder auswählen..."
            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-orange-500"
            autocomplete="off"
          />
          <div
            id="ingredient-dropdown"
            class="hidden absolute z-10 w-full mt-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg max-h-90 overflow-hidden"
          >
            <div class="p-2 border-b border-gray-200 dark:border-gray-700">
              <input
                type="text"
                id="ingredient-filter-input"
                placeholder="Zutaten filtern..."
                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-orange-500 text-sm"
                autocomplete="off"
              />
            </div>
            <div id="ingredient-options" class="max-h-72 overflow-y-auto">
              <!-- Options will be populated here -->
            </div>
          </div>
        </div>
      </div>
      <div class="flex justify-end space-x-3">
        <button
          id="cancel-unify-btn"
          class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
        >
          Abbrechen
        </button>
        <button
          id="confirm-unify-btn"
          class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg transition-colors"
        >
          Vereinheitlichen
        </button>
      </div>
    </div>
  </div>

  <script>
    let allIngredients: Array<{ name: string; usageCount: number }> = [];
    let currentOldIngredient: string = '';

    // Load ingredients on page load
    document.addEventListener('DOMContentLoaded', async () => {
      await loadIngredients();
      setupSearch();
      setupRecipesButtons();
      setupRenameButtons();
      setupUnifyButtons();
      setupRenameModal();
      setupModal();
      setupMergeSuggestionsButton();
    });

    async function loadIngredients() {
      try {
        const response = await fetch('/api/ingredients?all=true');
        if (response.ok) {
          allIngredients = await response.json();
        }
      } catch (error) {
        console.error('Error loading ingredients:', error);
      }
    }

    function setupSearch() {
      const searchInput = document.getElementById('ingredient-search') as HTMLInputElement;
      if (!searchInput) return;

      searchInput.addEventListener('input', (e) => {
        const query = (e.target as HTMLInputElement).value.toLowerCase();
        const items = document.querySelectorAll('.ingredient-item');

        items.forEach((item) => {
          const ingredientName = item.getAttribute('data-ingredient-name') || '';
          if (ingredientName.includes(query)) {
            (item as HTMLElement).style.display = '';
          } else {
            (item as HTMLElement).style.display = 'none';
          }
        });
      });
    }

    function setupRecipesButtons() {
      const recipesButtons = document.querySelectorAll('.recipes-btn');
      recipesButtons.forEach((btn) => {
        btn.addEventListener('click', (e) => {
          const ingredientName = (e.currentTarget as HTMLElement).getAttribute('data-ingredient-name') || '';
          if (window.openRecipesModal) {
            window.openRecipesModal(ingredientName);
          }
        });
      });
    }

    function setupRenameButtons() {
      const renameButtons = document.querySelectorAll('.rename-btn');
      renameButtons.forEach((btn) => {
        btn.addEventListener('click', (e) => {
          const ingredientName = (e.currentTarget as HTMLElement).getAttribute('data-ingredient-name') || '';
          openRenameModal(ingredientName);
        });
      });
    }

    function setupUnifyButtons() {
      const unifyButtons = document.querySelectorAll('.unify-btn');
      unifyButtons.forEach((btn) => {
        btn.addEventListener('click', (e) => {
          const ingredientName = (e.currentTarget as HTMLElement).getAttribute('data-ingredient-name') || '';
          openUnifyModal(ingredientName);
        });
      });
    }

    function setupMergeSuggestionsButton() {
      const mergeBtn = document.getElementById('merge-suggestions-btn');
      if (!mergeBtn) return;

      mergeBtn.addEventListener('click', async () => {
        if (window.openMergeSuggestionsModal) {
          await window.openMergeSuggestionsModal();
        }
      });
    }

    function setupRenameModal() {
      const modal = document.getElementById('rename-modal');
      const cancelBtn = document.getElementById('cancel-rename-btn');
      const confirmBtn = document.getElementById('confirm-rename-btn');
      const newIngredientInput = document.getElementById('rename-new-ingredient-input') as HTMLInputElement;

      if (!modal || !cancelBtn || !confirmBtn || !newIngredientInput) return;

      cancelBtn.addEventListener('click', () => {
        closeRenameModal();
      });

      confirmBtn.addEventListener('click', async () => {
        const newName = newIngredientInput.value.trim();
        if (!newName) {
          if (window.showWarning) {
            window.showWarning('Bitte geben Sie einen neuen Zutaten-Namen ein.');
          } else {
            alert('Bitte geben Sie einen neuen Zutaten-Namen ein.');
          }
          return;
        }

        if (newName === currentOldIngredient) {
          if (window.showWarning) {
            window.showWarning('Der neue Name muss sich vom alten Namen unterscheiden.');
          } else {
            alert('Der neue Name muss sich vom alten Namen unterscheiden.');
          }
          return;
        }

        await renameIngredient(currentOldIngredient, newName);
      });

      // Close modal on background click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeRenameModal();
        }
      });

      // Close modal on ESC key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
          closeRenameModal();
        }
      });
    }

    function setupModal() {
      const modal = document.getElementById('unify-modal');
      const cancelBtn = document.getElementById('cancel-unify-btn');
      const confirmBtn = document.getElementById('confirm-unify-btn');
      const newIngredientInput = document.getElementById('new-ingredient-input') as HTMLInputElement;
      const dropdown = document.getElementById('ingredient-dropdown');
      const filterInput = document.getElementById('ingredient-filter-input') as HTMLInputElement;
      const optionsContainer = document.getElementById('ingredient-options');

      if (!modal || !cancelBtn || !confirmBtn || !newIngredientInput || !dropdown || !filterInput || !optionsContainer) return;

      // Open dropdown when input is focused or clicked
      newIngredientInput.addEventListener('focus', () => {
        updateDropdownOptions('');
        dropdown?.classList.remove('hidden');
        setTimeout(() => {
          filterInput?.focus();
        }, 50);
      });

      newIngredientInput.addEventListener('click', () => {
        updateDropdownOptions('');
        dropdown?.classList.remove('hidden');
        setTimeout(() => {
          filterInput?.focus();
        }, 50);
      });

      // Also filter when typing directly in the main input
      newIngredientInput.addEventListener('input', (e) => {
        const inputValue = (e.target as HTMLInputElement).value;
        filterInput.value = inputValue;
        updateDropdownOptions(inputValue.toLowerCase());
        if (!dropdown.classList.contains('hidden') || inputValue.length > 0) {
          dropdown.classList.remove('hidden');
        }
      });

      // Filter options when typing in filter input
      filterInput.addEventListener('input', (e) => {
        const filterText = (e.target as HTMLInputElement).value.toLowerCase();
        updateDropdownOptions(filterText);
      });

      // Calculate similarity between two strings (simple Levenshtein-based)
      function calculateSimilarity(str1: string, str2: string): number {
        const s1 = str1.toLowerCase();
        const s2 = str2.toLowerCase();
        
        // Exact match
        if (s1 === s2) return 1.0;
        
        // One string contains the other
        if (s1.includes(s2) || s2.includes(s1)) return 0.8;
        
        // Calculate Levenshtein distance
        const len1 = s1.length;
        const len2 = s2.length;
        const matrix: number[][] = [];
        
        for (let i = 0; i <= len1; i++) {
          matrix[i] = [i];
        }
        
        for (let j = 0; j <= len2; j++) {
          matrix[0][j] = j;
        }
        
        for (let i = 1; i <= len1; i++) {
          for (let j = 1; j <= len2; j++) {
            const cost = s1[i - 1] === s2[j - 1] ? 0 : 1;
            matrix[i][j] = Math.min(
              matrix[i - 1][j] + 1,
              matrix[i][j - 1] + 1,
              matrix[i - 1][j - 1] + cost
            );
          }
        }
        
        const distance = matrix[len1][len2];
        const maxLen = Math.max(len1, len2);
        return 1 - (distance / maxLen);
      }

      // Handle option selection
      function selectOption(ingredientName: string) {
        newIngredientInput.value = ingredientName;
        dropdown.classList.add('hidden');
        filterInput.value = '';
        newIngredientInput.focus();
      }

      // Create option element
      function createOptionElement(ingredientName: string, isHighlighted: boolean = false) {
        const option = document.createElement('div');
        option.className = `px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer text-gray-900 dark:text-white ${isHighlighted ? 'bg-orange-50 dark:bg-orange-900/20' : ''}`;
        option.textContent = ingredientName;
        option.addEventListener('click', () => {
          selectOption(ingredientName);
        });
        return option;
      }

      // Update dropdown options based on filter
      function updateDropdownOptions(filterText: string) {
        if (!optionsContainer) return;
        
        optionsContainer.innerHTML = '';
        
        let filteredIngredients = allIngredients.filter((ing) => {
          if (ing.name === currentOldIngredient) return false;
          if (!filterText) return true;
          return ing.name.toLowerCase().includes(filterText);
        });

        if (filteredIngredients.length === 0) {
          const noResults = document.createElement('div');
          noResults.className = 'px-4 py-3 text-sm text-gray-500 dark:text-gray-400 text-center';
          noResults.textContent = 'Keine Zutaten gefunden';
          optionsContainer.appendChild(noResults);
          return;
        }

        // Calculate similarity scores and sort
        const ingredientsWithSimilarity = filteredIngredients.map((ing) => ({
          ...ing,
          similarity: calculateSimilarity(currentOldIngredient, ing.name)
        }));

        // Sort by similarity (highest first)
        ingredientsWithSimilarity.sort((a, b) => b.similarity - a.similarity);

        // Get top 5 most similar from filtered results
        const topSuggestions = ingredientsWithSimilarity.slice(0, 5);
        const remainingIngredients = ingredientsWithSimilarity.slice(5);

        // Add top suggestions with separator
        if (topSuggestions.length > 0) {
          topSuggestions.forEach((ing) => {
            const option = createOptionElement(ing.name, true);
            optionsContainer.appendChild(option);
          });

          // Add separator if there are remaining ingredients
          if (remainingIngredients.length > 0) {
            const separator = document.createElement('div');
            separator.className = 'px-4 py-2 text-xs font-semibold text-gray-500 dark:text-gray-400 border-t border-gray-200 dark:border-gray-700';
            separator.textContent = 'Weitere Zutaten';
            optionsContainer.appendChild(separator);
          }
        }

        // Add remaining ingredients
        remainingIngredients.forEach((ing) => {
          const option = createOptionElement(ing.name, false);
          optionsContainer.appendChild(option);
        });
      }

      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (dropdown && !dropdown.contains(e.target as Node) && e.target !== newIngredientInput) {
          dropdown.classList.add('hidden');
          filterInput.value = '';
        }
      });

      // Handle keyboard navigation
      filterInput.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          dropdown.classList.add('hidden');
          filterInput.value = '';
          newIngredientInput.focus();
        } else if (e.key === 'Enter') {
          e.preventDefault();
          const firstOption = optionsContainer?.querySelector('div[class*="cursor-pointer"]') as HTMLElement;
          if (firstOption) {
            selectOption(firstOption.textContent || '');
          }
        }
      });

      cancelBtn.addEventListener('click', () => {
        closeUnifyModal();
      });

      confirmBtn.addEventListener('click', async () => {
        const newName = newIngredientInput.value.trim();
        if (!newName) {
          if (window.showWarning) {
            window.showWarning('Bitte geben Sie einen Zutaten-Namen ein.');
          } else {
            alert('Bitte geben Sie einen Zutaten-Namen ein.');
          }
          return;
        }

        if (newName === currentOldIngredient) {
          if (window.showWarning) {
            window.showWarning('Die neue Zutat muss sich von der alten unterscheiden.');
          } else {
            alert('Die neue Zutat muss sich von der alten unterscheiden.');
          }
          return;
        }

        await unifyIngredients(currentOldIngredient, newName);
      });

      // Close modal on background click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeUnifyModal();
        }
      });

      // Close modal on ESC key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
          const dropdown = document.getElementById('ingredient-dropdown');
          if (dropdown && !dropdown.classList.contains('hidden')) {
            dropdown.classList.add('hidden');
            const filterInput = document.getElementById('ingredient-filter-input') as HTMLInputElement;
            if (filterInput) filterInput.value = '';
          } else {
            closeUnifyModal();
          }
        }
      });
    }

    function openRenameModal(oldIngredient: string) {
      currentOldIngredient = oldIngredient;
      const modal = document.getElementById('rename-modal');
      const oldNameSpan = document.getElementById('rename-old-ingredient-name');
      const newIngredientInput = document.getElementById('rename-new-ingredient-input') as HTMLInputElement;

      if (!modal || !oldNameSpan || !newIngredientInput) return;

      oldNameSpan.textContent = oldIngredient;
      newIngredientInput.value = oldIngredient;
      modal.classList.remove('hidden');
      newIngredientInput.focus();
      newIngredientInput.select();
    }

    function closeRenameModal() {
      const modal = document.getElementById('rename-modal');
      if (modal) {
        modal.classList.add('hidden');
      }
      currentOldIngredient = '';
    }

    function openUnifyModal(oldIngredient: string) {
      currentOldIngredient = oldIngredient;
      const modal = document.getElementById('unify-modal');
      const oldNameSpan = document.getElementById('old-ingredient-name');
      const newIngredientInput = document.getElementById('new-ingredient-input') as HTMLInputElement;
      const dropdown = document.getElementById('ingredient-dropdown');
      const filterInput = document.getElementById('ingredient-filter-input') as HTMLInputElement;

      if (!modal || !oldNameSpan || !newIngredientInput) return;

      oldNameSpan.textContent = oldIngredient;
      newIngredientInput.value = '';
      if (dropdown) dropdown.classList.add('hidden');
      if (filterInput) filterInput.value = '';
      modal.classList.remove('hidden');
      newIngredientInput.focus();
    }

    function closeUnifyModal() {
      const modal = document.getElementById('unify-modal');
      const dropdown = document.getElementById('ingredient-dropdown');
      const filterInput = document.getElementById('ingredient-filter-input') as HTMLInputElement;
      if (modal) {
        modal.classList.add('hidden');
      }
      if (dropdown) {
        dropdown.classList.add('hidden');
      }
      if (filterInput) {
        filterInput.value = '';
      }
      currentOldIngredient = '';
    }

    async function renameIngredient(oldName: string, newName: string) {
      try {
        const response = await fetch('/api/ingredients', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            action: 'rename',
            oldName: oldName,
            newName: newName
          })
        });

        if (!response.ok) {
          const error = await response.json();
          if (window.showWarning) {
            window.showWarning(error.error || 'Fehler beim Umbenennen der Zutat.');
          } else {
            alert(error.error || 'Fehler beim Umbenennen der Zutat.');
          }
          return;
        }

        const result = await response.json();
        
        let message = `"${oldName}" wurde erfolgreich in "${newName}" umbenannt. ${result.updated} Rezept(e) wurden aktualisiert.`;
        if (result.shoppingListsUpdated > 0) {
          message += ` ${result.shoppingListsUpdated} Einkaufsliste(n) wurden ebenfalls aktualisiert.`;
        }
        
        if (window.showInfo) {
          window.showInfo(message);
        } else {
          alert(message);
        }

        closeRenameModal();
        
        // Reload the page to show updated ingredients
        window.location.reload();
      } catch (error) {
        console.error('Error renaming ingredient:', error);
        if (window.showWarning) {
          window.showWarning('Fehler beim Umbenennen der Zutat. Bitte versuchen Sie es erneut.');
        } else {
          alert('Fehler beim Umbenennen der Zutat. Bitte versuchen Sie es erneut.');
        }
      }
    }

    async function unifyIngredients(oldName: string, newName: string) {
      try {
        const response = await fetch('/api/ingredients', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            action: 'unify',
            oldName: oldName,
            newName: newName
          })
        });

        if (!response.ok) {
          const error = await response.json();
          if (window.showWarning) {
            window.showWarning(error.error || 'Fehler beim Vereinheitlichen der Zutat.');
          } else {
            alert(error.error || 'Fehler beim Vereinheitlichen der Zutat.');
          }
          return;
        }

        const result = await response.json();
        
        let message = `"${oldName}" wurde erfolgreich in "${newName}" umbenannt. ${result.updated} Rezept(e) wurden aktualisiert.`;
        if (result.shoppingListsUpdated > 0) {
          message += ` ${result.shoppingListsUpdated} Einkaufsliste(n) wurden ebenfalls aktualisiert.`;
        }
        
        if (window.showInfo) {
          window.showInfo(message);
        } else {
          alert(message);
        }

        closeUnifyModal();
        
        // Reload the page to show updated ingredients
        window.location.reload();
      } catch (error) {
        console.error('Error unifying ingredients:', error);
        if (window.showWarning) {
          window.showWarning('Fehler beim Vereinheitlichen der Zutat. Bitte versuchen Sie es erneut.');
        } else {
          alert('Fehler beim Vereinheitlichen der Zutat. Bitte versuchen Sie es erneut.');
        }
      }
    }
  </script>
</Layout>

