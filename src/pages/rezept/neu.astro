---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Neues Rezept - Kochbuch">
  <div class="container-narrow">
    <div class="card">
      <div class="card-content">
        <h1 class="heading-primary mb-6">Neues Rezept erstellen</h1>
        
        <form id="recipe-form" class="space-y-8">
          <!-- Header Section -->
          <div class="border-b border-gray-200 dark:border-gray-600 pb-6">
            <h2 class="heading-tertiary mb-4">Grundinformationen</h2>
            
            <div class="space-y-standard">
              <div class="form-group">
                <label for="title" class="form-label">
                  Titel <span class="text-red-500">*</span>
                </label>
                <input 
                  type="text" 
                  id="title" 
                  name="title" 
                  class="form-input"
                  placeholder="z.B. Spaghetti Carbonara"
                  required
                />
              </div>
              
              <div class="form-group">
                <label for="subtitle" class="form-label">
                  Untertitel
                </label>
                <input 
                  type="text" 
                  id="subtitle" 
                  name="subtitle" 
                  class="form-input"
                  placeholder="z.B. Klassisch italienisch"
                />
              </div>
              
              <div class="form-group">
                <label for="description" class="form-label">
                  Beschreibung
                </label>
                <textarea 
                  id="description" 
                  name="description" 
                  rows="3"
                  class="form-textarea"
                  placeholder="Kurze Beschreibung des Rezepts..."
                ></textarea>
              </div>
            </div>
          </div>

          <!-- Metadata Section -->
          <div class="border-b border-gray-200 dark:border-gray-600 pb-6">
            <h2 class="heading-tertiary mb-4">Metadaten</h2>
            
            <div class="grid-four-cols">
              <div class="form-group">
                <label for="servings" class="form-label">
                  Portionen
                </label>
                <input 
                  type="number" 
                  id="servings" 
                  name="servings" 
                  min="1"
                  class="form-input"
                  placeholder="4"
                />
              </div>
              
              <div class="form-group">
                <label for="preparationTime" class="form-label">
                  Vorbereitungszeit (Min)
                </label>
                <input 
                  type="number" 
                  id="preparationTime" 
                  name="preparationTime" 
                  min="0"
                  class="form-input"
                  placeholder="20"
                />
              </div>
              
              <div class="form-group">
                <label for="cookingTime" class="form-label">
                  Kochzeit (Min)
                </label>
                <input 
                  type="number" 
                  id="cookingTime" 
                  name="cookingTime" 
                  min="0"
                  class="form-input"
                  placeholder="15"
                />
              </div>
              
              <div class="form-group">
                <label for="difficulty" class="form-label">
                  Schwierigkeit
                </label>
                <select 
                  id="difficulty" 
                  name="difficulty" 
                  class="form-select"
                >
                  <option value="">Wählen...</option>
                  <option value="leicht">Leicht</option>
                  <option value="mittel">Mittel</option>
                  <option value="schwer">Schwer</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Ingredients Section -->
          <div class="border-b border-gray-200 pb-6">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-xl font-semibold text-gray-900">Zutaten</h2>
              <button 
                type="button" 
                id="add-ingredient-group"
                class="px-3 py-1 text-sm bg-orange-500 hover:bg-orange-600 text-white rounded transition-colors"
              >
                + Gruppe hinzufügen
              </button>
            </div>
            
            <div id="ingredients-container">
              <!-- Default ingredient group -->
              <div class="ingredient-group border border-gray-200 rounded-md p-4 mb-4">
                <div class="flex justify-between items-center mb-3">
                  <input 
                    type="text" 
                    placeholder="Gruppenname (optional)" 
                    class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent mr-3"
                  />
                  <button 
                    type="button" 
                    class="remove-ingredient-group px-2 py-1 text-red-600 hover:text-red-700 text-sm"
                  >
                    Entfernen
                  </button>
                </div>
                
                <div class="ingredients-list space-y-2">
                  <div class="ingredient-item flex space-x-2">
                    <input 
                      type="text" 
                      placeholder="Zutat" 
                      class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                      list="ingredients-datalist"
                    />
                    <input 
                      type="number" 
                      placeholder="Menge" 
                      step="0.1"
                      class="w-20 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                    />
                    <select class="w-24 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                      <option value="">Einheit</option>
                      <option value="g">g</option>
                      <option value="kg">kg</option>
                      <option value="ml">ml</option>
                      <option value="l">l</option>
                      <option value="Stück">Stück</option>
                      <option value="TL">TL</option>
                      <option value="EL">EL</option>
                      <option value="Tasse">Tasse</option>
                      <option value="Prise">Prise</option>
                    </select>
                    <button 
                      type="button" 
                      class="remove-ingredient px-2 py-1 text-red-600 hover:text-red-700"
                    >
                      ×
                    </button>
                  </div>
                </div>
                
                <button 
                  type="button" 
                  class="add-ingredient mt-2 px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 rounded transition-colors"
                >
                  + Zutat hinzufügen
                </button>
              </div>
            </div>
          </div>

          <!-- Preparation Section -->
          <div class="border-b border-gray-200 pb-6">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-xl font-semibold text-gray-900">Zubereitung</h2>
              <button 
                type="button" 
                id="add-preparation-group"
                class="px-3 py-1 text-sm bg-orange-500 hover:bg-orange-600 text-white rounded transition-colors"
              >
                + Gruppe hinzufügen
              </button>
            </div>
            
            <div id="preparation-container">
              <!-- Default preparation group -->
              <div class="preparation-group border border-gray-200 rounded-md p-4 mb-4">
                <div class="flex justify-between items-center mb-3">
                  <input 
                    type="text" 
                    placeholder="Gruppenname (optional)" 
                    class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent mr-3"
                  />
                  <button 
                    type="button" 
                    class="remove-preparation-group px-2 py-1 text-red-600 hover:text-red-700 text-sm"
                  >
                    Entfernen
                  </button>
                </div>
                
                <div class="preparation-steps space-y-3">
                  <div class="preparation-step border border-gray-200 rounded p-3">
                    <textarea 
                      placeholder="Zubereitungsschritt..." 
                      rows="2"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent mb-2"
                    ></textarea>
                    <div class="flex justify-between items-center">
                      <div class="flex space-x-2">
                        <button 
                          type="button" 
                          class="link-ingredients px-3 py-1 text-sm bg-blue-100 hover:bg-blue-200 text-blue-700 rounded transition-colors"
                        >
                          Zutaten verlinken
                        </button>
                      </div>
                      <button 
                        type="button" 
                        class="remove-step px-2 py-1 text-red-600 hover:text-red-700 text-sm"
                      >
                        Entfernen
                      </button>
                    </div>
                  </div>
                </div>
                
                <button 
                  type="button" 
                  class="add-step mt-2 px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 rounded transition-colors"
                >
                  + Schritt hinzufügen
                </button>
              </div>
            </div>
          </div>

          <!-- Submit Buttons -->
          <div class="flex justify-end space-x-3">
            <button 
              type="button" 
              class="btn btn-secondary px-6 py-2"
            >
              Abbrechen
            </button>
            <button 
              type="submit"
              class="btn btn-primary px-6 py-2"
            >
              Rezept speichern
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Ingredient autocomplete datalist -->
  <datalist id="ingredients-datalist">
    <!-- Options will be populated dynamically -->
  </datalist>

  <script>
    const recipeForm = document.getElementById('recipe-form');
    const datalist = document.getElementById('ingredients-datalist');
    let ingredientsCache = new Set<string>();

    // Load initial ingredients
    async function loadIngredients(query = '') {
      try {
        const response = await fetch(`/api/ingredients?q=${encodeURIComponent(query)}`);
        if (response.ok) {
          const ingredients: string[] = await response.json();
          updateDatalist(ingredients);
          // Cache the ingredients
          ingredients.forEach((ingredient: string) => ingredientsCache.add(ingredient));
        }
      } catch (error) {
        console.error('Error loading ingredients:', error);
      }
    }

    function updateDatalist(ingredients: string[]) {
      if (datalist) {
        datalist.innerHTML = '';
        ingredients.forEach((ingredient: string) => {
          const option = document.createElement('option');
          option.value = ingredient;
          datalist.appendChild(option);
        });
      }
    }

    // Add input listeners to ingredient fields for dynamic search
    function addIngredientInputListeners() {
      const ingredientInputs = document.querySelectorAll('input[list="ingredients-datalist"]');
      ingredientInputs.forEach(input => {
        let debounceTimer: ReturnType<typeof setTimeout>;
        input.addEventListener('input', (e) => {
          clearTimeout(debounceTimer);
          const target = e.target as HTMLInputElement;
          const query = target?.value || '';
          
          if (query.length >= 2) {
            debounceTimer = setTimeout(() => {
              loadIngredients(query);
            }, 300);
          } else if (query.length === 0) {
            // Show cached ingredients when empty
            updateDatalist([...ingredientsCache].slice(0, 20));
          }
        });
      });
    }

    // Initialize ingredients and add listeners
    document.addEventListener('DOMContentLoaded', () => {
      loadIngredients(); // Load initial set of ingredients
      addIngredientInputListeners();
    });

    // Re-add listeners when new ingredient inputs are created
    const observer = new MutationObserver(() => {
      addIngredientInputListeners();
    });
    
    const ingredientsContainer = document.getElementById('ingredients-container');
    if (ingredientsContainer) {
      observer.observe(ingredientsContainer, {
        childList: true,
        subtree: true
      });
    }

    recipeForm?.addEventListener('submit', (e) => {
      e.preventDefault();
      window.location.href = '/';
    });
  </script>
</Layout> 