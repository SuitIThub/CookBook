---
import Layout from '../../layouts/Layout.astro';
import { db } from '../../lib/database';
import type { Recipe } from '../../types/recipe';

// Import the new components
import RecipeHeader from '../../components/recipe/details/RecipeHeader.astro';
import IngredientsList from '../../components/recipe/details/IngredientsList.astro';
import PreparationSteps from '../../components/recipe/details/PreparationSteps.astro';
import EditRecipeForm from '../../components/recipe/edit/EditRecipeForm.astro';
import RecipeImageGallery from '../../components/recipe/RecipeImageGallery.astro';

const { id } = Astro.params;

// Rezept aus der Datenbank laden
let recipe: Recipe | null = null;
try {
  recipe = id ? db.getRecipe(id as string) : null;
  if (!recipe) {
    return Astro.redirect('/404');
  }
} catch (error) {
  console.error('Error loading recipe from database:', error);
  return Astro.redirect('/404');
}
---

<Layout title={`${recipe.title} - Kochbuch`}>
  <div class="max-w-4xl mx-auto">
    <!-- Header Section -->
    <RecipeHeader recipe={recipe} />

    <!-- View Mode Content -->
    <div id="view-content" class="space-y-6">
      <!-- Image Gallery -->
      <RecipeImageGallery recipe={recipe} mode="view" />
      
      <!-- Recipe Sections -->
      <div class="grid md:grid-cols-2 gap-6">
        <!-- Ingredients Section -->
        <IngredientsList recipe={recipe} />

        <!-- Preparation Section -->
        <PreparationSteps recipe={recipe} />
      </div>
    </div>

    <!-- Edit Mode Content (initially hidden) -->
    <div id="edit-content" class="hidden">
      <EditRecipeForm recipe={recipe} />
    </div>
  </div>

  <script define:vars={{ recipe }}>
    // Timer functionality
    document.querySelectorAll('.timer-trigger').forEach(button => {
      button.addEventListener('click', (e) => {
        const target = e.target;
        const timeText = target.dataset.time || '';
        const recipeName = target.dataset.recipeName || recipe.title;
        const stepDescription = target.dataset.stepDescription || '';
        const stepId = target.dataset.stepId || '';
        
        // Parse time string correctly to handle hours and minutes
        function parseTimeToSeconds(timeStr) {
          const str = timeStr.toLowerCase();
          let totalMinutes = 0;
          
          // Match hours (Stunden, Std.)
          const hourMatch = str.match(/(\d+)\s*(?:stunden?|std\.?)/i);
          if (hourMatch) {
            totalMinutes += parseInt(hourMatch[1]) * 60;
          }
          
          // Match minutes (Minuten, Min.)
          const minuteMatch = str.match(/(\d+)\s*(?:minuten?|min\.?)/i);
          if (minuteMatch) {
            totalMinutes += parseInt(minuteMatch[1]);
          }
          
          // If no specific unit found, assume minutes
          if (totalMinutes === 0) {
            const numberMatch = str.match(/(\d+)/);
            if (numberMatch) {
              totalMinutes = parseInt(numberMatch[1]);
            }
          }
          
          return totalMinutes * 60; // Convert to seconds
        }
        
        const seconds = parseTimeToSeconds(timeText);
        
        // Call timer with recipe context and navigation info
        window.startTimer(timeText, seconds, recipeName, stepDescription, true, recipe.id, stepId);
      });
    });

    // Portion scaling functionality
    const currentServingsElement = document.getElementById('current-servings');
    const decreaseButton = document.getElementById('decrease-servings');
    const increaseButton = document.getElementById('increase-servings');
    const resetButton = document.getElementById('reset-servings');
    
    if (currentServingsElement && decreaseButton && increaseButton && resetButton) {
      const originalServings = parseInt(currentServingsElement.getAttribute('data-original') || '1');
      
      function updateServings(newServings) {
        if (newServings < 1) newServings = 1;
        if (newServings > 99) newServings = 99;
        
        if (currentServingsElement) {
          currentServingsElement.textContent = newServings.toString();
        }
        
        // Show/hide reset button
        if (resetButton) {
          if (newServings !== originalServings) {
            resetButton.style.display = 'inline-block';
          } else {
            resetButton.style.display = 'none';
          }
        }
        
        // Calculate scaling factor
        const scalingFactor = newServings / originalServings;
        
        // Update all ingredient amounts
        document.querySelectorAll('.ingredient-amount').forEach((element) => {
          const htmlElement = element;
          const originalAmount = parseFloat(htmlElement.getAttribute('data-original-amount') || '0');
          const amountValueElement = element.querySelector('.amount-value');
          
          if (amountValueElement && !isNaN(originalAmount)) {
            let scaledAmount = originalAmount * scalingFactor;
            
            // Round to reasonable decimal places
            if (scaledAmount < 1) {
              scaledAmount = Math.round(scaledAmount * 100) / 100;
            } else if (scaledAmount < 10) {
              scaledAmount = Math.round(scaledAmount * 10) / 10;
            } else {
              scaledAmount = Math.round(scaledAmount);
            }
            
            const formattedAmount = scaledAmount % 1 === 0 ? scaledAmount.toString() : scaledAmount.toString();
            amountValueElement.textContent = formattedAmount;
          }
        });
      }
      
      decreaseButton.addEventListener('click', () => {
        if (currentServingsElement) {
          const current = parseInt(currentServingsElement.textContent || '1');
          updateServings(current - 1);
        }
      });
      
      increaseButton.addEventListener('click', () => {
        if (currentServingsElement) {
          const current = parseInt(currentServingsElement.textContent || '1');
          updateServings(current + 1);
        }
      });
      
      resetButton.addEventListener('click', () => {
        updateServings(originalServings);
      });
    }

    // Edit mode functionality
    let isEditMode = false;
    const editBtn = document.getElementById('edit-btn');
    const editBtnMobile = document.getElementById('edit-btn-mobile');
    const viewContent = document.getElementById('view-content');
    const editContent = document.getElementById('edit-content');

    function updateEditButton(button, isEdit) {
      if (!button) return;
      
      if (isEdit) {
        button.innerHTML = `
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
          <span>Abbrechen</span>
        `;
        button.className = button.className.replace('bg-blue-500 hover:bg-blue-600', 'bg-gray-500 hover:bg-gray-600');
      } else {
        button.innerHTML = `
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
          </svg>
          <span>Bearbeiten</span>
        `;
        button.className = button.className.replace('bg-gray-500 hover:bg-gray-600', 'bg-blue-500 hover:bg-blue-600');
      }
    }

    function toggleEditMode() {
      isEditMode = !isEditMode;
      
      if (isEditMode) {
        viewContent?.classList.add('hidden');
        editContent?.classList.remove('hidden');
        updateEditButton(editBtn, true);
        updateEditButton(editBtnMobile, true);
      } else {
        viewContent?.classList.remove('hidden');
        editContent?.classList.add('hidden');
        updateEditButton(editBtn, false);
        updateEditButton(editBtnMobile, false);
      }
    }

    // Make toggleEditMode globally available
    window.toggleEditMode = toggleEditMode;

    editBtn?.addEventListener('click', toggleEditMode);
    editBtnMobile?.addEventListener('click', toggleEditMode);

    // Shopping list functionality
    const addToShoppingBtn = document.getElementById('add-to-shopping');
    const addToShoppingBtnMobile = document.getElementById('add-to-shopping-mobile');

    async function addRecipeToShoppingList() {
      try {
        // Get or create default shopping list
        let shoppingListId = localStorage.getItem('defaultShoppingListId');
        
        if (!shoppingListId) {
          // Create default shopping list if it doesn't exist
          const createResponse = await fetch('/api/shopping-lists', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ title: 'Meine Einkaufsliste' })
          });
          
          if (createResponse.ok) {
            const newList = await createResponse.json();
            shoppingListId = newList.id;
            localStorage.setItem('defaultShoppingListId', shoppingListId);
          } else {
            throw new Error('Failed to create shopping list');
          }
        }

        // Add each ingredient to the shopping list
        const ingredients = recipe.ingredients || [];
        let addedCount = 0;
        
        for (const ingredient of ingredients) {
          if (ingredient.name) {
            const response = await fetch(`/api/shopping-lists?id=${shoppingListId}`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                action: 'add-item',
                item: {
                  name: ingredient.name,
                  amount: ingredient.amount || '',
                  unit: ingredient.unit || '',
                  isChecked: false
                }
              })
            });
            
            if (response.ok) {
              addedCount++;
            }
          }
        }
        
        if (addedCount > 0) {
          alert(`${addedCount} Zutat(en) zur Einkaufsliste hinzugefügt!`);
        } else {
          alert('Keine Zutaten zum Hinzufügen gefunden.');
        }
        
      } catch (error) {
        console.error('Error adding to shopping list:', error);
        alert('Fehler beim Hinzufügen zur Einkaufsliste. Bitte versuchen Sie es erneut.');
      }
    }

    addToShoppingBtn?.addEventListener('click', addRecipeToShoppingList);
    addToShoppingBtnMobile?.addEventListener('click', addRecipeToShoppingList);

    // Edit mode event handlers
    document.getElementById('cancel-edit-btn')?.addEventListener('click', () => {
      toggleEditMode(); // Switch back to view mode
    });

    // Delete recipe functionality
    document.getElementById('delete-recipe-btn')?.addEventListener('click', async () => {
      const titleElement = document.getElementById('edit-title');
      const recipeTitle = titleElement?.value || 'Dieses Rezept';
      
      const confirmed = confirm(`Sind Sie sicher, dass Sie "${recipeTitle}" löschen möchten?\n\nDiese Aktion kann nicht rückgängig gemacht werden.`);
      
      if (!confirmed) {
        return;
      }
      
      try {
        const deleteBtn = document.getElementById('delete-recipe-btn');
        if (deleteBtn) {
          deleteBtn.textContent = 'Löschen...';
          deleteBtn.setAttribute('disabled', 'true');
        }
        
        const recipeId = window.location.pathname.split('/').pop();
        
        const response = await fetch(`/api/recipes?id=${recipeId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          alert('Rezept wurde erfolgreich gelöscht.');
          window.location.href = '/';
        } else {
          const error = await response.text();
          console.error('Server error:', error);
          throw new Error(`Server error: ${response.status}`);
        }
        
      } catch (error) {
        console.error('Error deleting recipe:', error);
        alert('Fehler beim Löschen des Rezepts. Bitte versuchen Sie es erneut.');
        
        const deleteBtn = document.getElementById('delete-recipe-btn');
        if (deleteBtn) {
          deleteBtn.textContent = 'Rezept löschen';
          deleteBtn.removeAttribute('disabled');
        }
      }
    });

    // Check if we should auto-enter edit mode (for new recipes)
    function checkAutoEditMode() {
      const urlParams = new URLSearchParams(window.location.search);
      const shouldEdit = urlParams.get('edit');
      
      if (shouldEdit === 'true') {
        const newUrl = window.location.pathname;
        window.history.replaceState({}, '', newUrl);
        toggleEditMode();
      }
    }
    
    // Initialize all event listeners and check for auto-edit mode
    checkAutoEditMode();
    
    // Check for step highlight hash on page load
    function checkStepHighlight() {
      const hash = window.location.hash;
      if (hash.startsWith('#step-')) {
        const stepId = hash.substring(6); // Remove '#step-' prefix
        setTimeout(() => {
          const stepElement = document.getElementById(`step-${stepId}`);
          if (stepElement) {
            // Add highlight class
            stepElement.classList.add('step-highlight');
            
            // Scroll to element
            stepElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Remove highlight after animation
            setTimeout(() => {
              stepElement.classList.remove('step-highlight');
            }, 2000);
          }
        }, 500); // Wait a bit for page to fully load
      }
    }
    
    // Check for step highlight on load and hash change
    checkStepHighlight();
    window.addEventListener('hashchange', checkStepHighlight);

    // Export functionality for recipe detail page
    const exportRecipeBtn = document.getElementById('export-recipe-btn');
    const exportRecipeBtnMobile = document.getElementById('export-recipe-btn-mobile');
    const exportRecipeMenu = document.getElementById('export-recipe-menu');
    const exportRecipeMenuMobile = document.getElementById('export-recipe-menu-mobile');
    const exportRecipeJsonBtn = document.getElementById('export-recipe-json');
    const exportRecipeJsonBtnMobile = document.getElementById('export-recipe-json-mobile');
    const exportRecipeRcbBtn = document.getElementById('export-recipe-rcb');
    const exportRecipeRcbBtnMobile = document.getElementById('export-recipe-rcb-mobile');

    // Toggle export dropdown for desktop
    exportRecipeBtn?.addEventListener('click', (e) => {
      e.stopPropagation();
      exportRecipeMenu?.classList.toggle('hidden');
      exportRecipeMenuMobile?.classList.add('hidden'); // Close mobile menu if open
    });

    // Toggle export dropdown for mobile
    exportRecipeBtnMobile?.addEventListener('click', (e) => {
      e.stopPropagation();
      exportRecipeMenuMobile?.classList.toggle('hidden');
      exportRecipeMenu?.classList.add('hidden'); // Close desktop menu if open
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', () => {
      exportRecipeMenu?.classList.add('hidden');
      exportRecipeMenuMobile?.classList.add('hidden');
    });

    // Export handlers for desktop
    exportRecipeJsonBtn?.addEventListener('click', () => {
      const recipeId = exportRecipeJsonBtn.getAttribute('data-recipe-id');
      window.location.href = `/api/recipe-export?id=${recipeId}&format=json`;
      exportRecipeMenu?.classList.add('hidden');
    });

    exportRecipeRcbBtn?.addEventListener('click', () => {
      const recipeId = exportRecipeRcbBtn.getAttribute('data-recipe-id');
      window.location.href = `/api/recipe-export?id=${recipeId}&format=rcb`;
      exportRecipeMenu?.classList.add('hidden');
    });

    // Export handlers for mobile
    exportRecipeJsonBtnMobile?.addEventListener('click', () => {
      const recipeId = exportRecipeJsonBtnMobile.getAttribute('data-recipe-id');
      window.location.href = `/api/recipe-export?id=${recipeId}&format=json`;
      exportRecipeMenuMobile?.classList.add('hidden');
    });

    exportRecipeRcbBtnMobile?.addEventListener('click', () => {
      const recipeId = exportRecipeRcbBtnMobile.getAttribute('data-recipe-id');
      window.location.href = `/api/recipe-export?id=${recipeId}&format=rcb`;
      exportRecipeMenuMobile?.classList.add('hidden');
    });
  </script>
</Layout> 