---
import type { Recipe, RecipeImage } from '../../types/recipe';
import LightboxModal from '../modals/LightboxModal.astro';
import ImageUploadModal from '../modals/ImageUploadModal.astro';

interface Props {
  recipe: Recipe;
  mode: 'view' | 'edit';
}

const { recipe, mode } = Astro.props;
const images = recipe.images || [];
---

<div data-recipe-images={JSON.stringify(images)} data-recipe-id={recipe.id} data-mode={mode}>
  {images.length > 0 && (
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 mb-6 p-6">
      <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Bilder</h2>
      
      <!-- Image Gallery -->
      <div class="flex space-x-4 overflow-x-auto pb-2 scrollbar-thin scrollbar-thumb-gray-300 dark:scrollbar-thumb-gray-600">
        {images.map((image: RecipeImage) => (
          <div class="flex-shrink-0 relative group">
            <div class="w-32 h-32 rounded-lg overflow-hidden bg-gray-100 dark:bg-gray-700">
              <img 
                src={image.url} 
                alt="Recipe image" 
                class="w-full h-full object-cover cursor-pointer hover:scale-105 transition-transform duration-200"
                data-lightbox="recipe-gallery"
                data-image-id={image.id}
              />
            </div>
            
            {mode === 'edit' && (
              <button 
                type="button"
                class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center text-xs font-bold shadow-md transition-colors delete-image-btn"
                data-recipe-id={recipe.id}
                data-image-id={image.id}
                title="Bild löschen"
              >
                ×
              </button>
            )}
          </div>
        ))}
        
        <div class="flex-shrink-0">
          <button 
            type="button"
            class="block w-32 h-32 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer hover:border-orange-400 dark:hover:border-orange-500 transition-colors bg-gray-50 dark:bg-gray-700/50"
            data-recipe-id={recipe.id}
            id="add-image-btn"
          >
            <div class="flex flex-col items-center justify-center h-full text-gray-500 dark:text-gray-400">
              <svg class="w-8 h-8 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
              </svg>
              <span class="text-xs text-center">Bild hinzufügen</span>
            </div>
          </button>
        </div>
      </div>
    </div>
  )}

  {mode === 'view' && images.length === 0 && recipe.id && (
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 mb-6 p-6">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Bilder</h2>
        <button 
          type="button"
          class="flex items-center space-x-2 px-3 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-md text-sm font-medium cursor-pointer transition-colors"
          data-recipe-id={recipe.id}
          id="add-first-image-btn"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          <span>Erstes Bild hinzufügen</span>
        </button>
      </div>
      <p class="text-gray-600 dark:text-gray-400 text-sm mt-2">Fügen Sie Bilder hinzu, um Ihr Rezept visuell zu präsentieren.</p>
    </div>
  )}

  <LightboxModal images={images} />
  <ImageUploadModal />
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    let currentImageIndex = 0;
    let recipeImages: any[] = [];
    let recipeId = '';
    
    // Initialize data from container
    const container = document.querySelector('[data-recipe-images]') as HTMLElement;
    if (container) {
      recipeImages = JSON.parse(container.dataset.recipeImages || '[]');
      recipeId = container.dataset.recipeId || '';
    }

    // Modal handlers - functionality moved to ImageUploadModal component
    const addImageBtns = document.querySelectorAll('#add-image-btn, #add-first-image-btn');
    addImageBtns.forEach(btn => {
      btn.addEventListener('click', (e) => {
        if (window.openImageUploadModal) {
          window.openImageUploadModal(e);
        }
      });
    });

    // Delete image handlers
    const deleteButtons = document.querySelectorAll('.delete-image-btn');
    deleteButtons.forEach(button => {
      button.addEventListener('click', handleImageDelete);
    });

    // Lightbox handlers - functionality moved to LightboxModal component

    function showNotification(message: string, type: 'success' | 'error' | 'info' = 'info') {
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg shadow-lg text-white ${
        type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'
      }`;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    async function handleImageDelete(event: Event) {
      const target = event.target as HTMLButtonElement;
      const targetRecipeId = target.dataset.recipeId || recipeId;
      const imageId = target.dataset.imageId;

      if (!targetRecipeId || !imageId) return;
      
      // Wait for modal functions to be available
      let attempts = 0;
      while (!window.showDeleteConfirm && attempts < 10) {
        await new Promise(resolve => setTimeout(resolve, 200));
        attempts++;
      }

      let confirmed = false;
      if (window.showDeleteConfirm) {
        confirmed = await window.showDeleteConfirm('Möchten Sie dieses Bild wirklich löschen?');
      } else {
        confirmed = confirm('Möchten Sie dieses Bild wirklich löschen?');
      }

      if (!confirmed) return;

      try {
        const response = await fetch(`/api/recipes/images?recipeId=${targetRecipeId}&imageId=${imageId}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          if (window.showSuccess) {
            await window.showSuccess('Bild erfolgreich gelöscht!');
          } else {
            showNotification('Bild erfolgreich gelöscht!', 'success');
          }
          
          // Remove image from DOM immediately for better UX
          target.closest('.relative')?.remove();
          
          // Update local images array
          recipeImages = recipeImages.filter(img => img.id !== imageId);
        } else {
          const error = await response.json();
          console.error('Delete error response:', error);
          if (window.showError) {
            await window.showError(error.error || 'Fehler beim Löschen des Bildes');
          } else {
            showNotification(error.error || 'Fehler beim Löschen des Bildes', 'error');
          }
        }
      } catch (error) {
        console.error('Delete error:', error);
        if (window.showError) {
          await window.showError('Fehler beim Löschen des Bildes');
        } else {
          showNotification('Fehler beim Löschen des Bildes', 'error');
        }
      }
    }

    // Image upload and lightbox functionality moved to modal components
  });
</script>

<style>
  .scrollbar-thin {
    scrollbar-width: thin;
  }
  
  .scrollbar-thumb-gray-300::-webkit-scrollbar {
    height: 6px;
  }
  
  .scrollbar-thumb-gray-300::-webkit-scrollbar-thumb {
    background-color: rgb(209 213 219);
    border-radius: 3px;
  }
  
  .dark .scrollbar-thumb-gray-600::-webkit-scrollbar-thumb {
    background-color: rgb(75 85 99);
  }
</style> 