---
interface Props {
  recipeId: string;
  /** When true, only show "Als neue Variante speichern" and "Abbrechen" (no normal Save, no Delete). Used for AI variant draft. */
  isVariantDraft?: boolean;
  /** For variant draft: redirect here on Cancel. */
  parentRecipeId?: string;
}

const { recipeId, isVariantDraft = false, parentRecipeId } = Astro.props;
---

<div class="mt-8 mb-4">
  {isVariantDraft ? (
    <!-- Variant draft mode: only save as new variant + cancel -->
    <>
      <div class="sm:hidden flex flex-col space-y-3">
        <button type="button" id="save-variant-draft-btn-mobile" class="px-6 py-4 bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg transition-colors flex items-center justify-center gap-2 w-full text-base font-medium">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4h9v9H4zM9 9h9v9H9z"/></svg>
          <span>Als neue Variante speichern</span>
        </button>
        <button type="button" id="cancel-variant-draft-btn-mobile" class="px-6 py-4 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border-2 border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 w-full text-base font-medium">
          Abbrechen
        </button>
      </div>
      <div class="hidden sm:flex justify-end items-center gap-3 max-w-4xl mx-auto">
        <button type="button" id="cancel-variant-draft-btn-desktop" class="px-6 py-3 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700">
          Abbrechen
        </button>
        <button type="button" id="save-variant-draft-btn-desktop" class="px-6 py-3 bg-indigo-500 hover:bg-indigo-600 text-white rounded-md transition-colors flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4h9v9H4zM9 9h9v9H9z"/></svg>
          <span>Als neue Variante speichern</span>
        </button>
      </div>
    </>
  ) : (
    <>
  <!-- Mobile layout -->
  <div class="sm:hidden">
    <div class="flex flex-col space-y-3">
      <!-- Save button at bottom (mobile) -->
      <button 
        type="button" 
        id="save-btn-bottom-mobile"
        class="px-6 py-4 bg-green-500 hover:bg-green-600 active:bg-green-700 text-white rounded-lg transition-colors flex items-center justify-center space-x-2 w-full text-base font-medium shadow-sm touch-manipulation"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
        <span>Speichern</span>
      </button>
      <!-- Save as variant button (mobile) -->
      <button 
        type="button" 
        id="save-as-variant-btn-mobile"
        class="px-6 py-4 bg-indigo-500 hover:bg-indigo-600 active:bg-indigo-700 text-white rounded-lg transition-colors flex items-center justify-center space-x-2 w-full text-base font-medium shadow-sm touch-manipulation"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4h9v9H4zM9 9h9v9H9z"/>
        </svg>
        <span>Als Variante speichern</span>
      </button>
      <button 
        type="button" 
        id="delete-recipe-btn"
        class="px-6 py-4 bg-red-500 hover:bg-red-600 active:bg-red-700 text-white rounded-lg transition-colors flex items-center justify-center space-x-2 w-full text-base font-medium shadow-sm touch-manipulation"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
        </svg>
        <span>Rezept löschen</span>
      </button>
      <button 
        type="button" 
        id="cancel-edit-btn"
        class="px-6 py-4 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border-2 border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 active:bg-gray-100 dark:active:bg-gray-600 transition-colors w-full text-base font-medium shadow-sm touch-manipulation"
      >
        Abbrechen
      </button>
    </div>
  </div>

  <!-- Desktop layout -->
  <div class="hidden sm:flex justify-between items-center max-w-4xl mx-auto">
    <button 
      type="button" 
      id="delete-recipe-btn-desktop"
      class="px-6 py-3 bg-red-500 hover:bg-red-600 text-white rounded-md transition-colors flex items-center space-x-2"
    >
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
      </svg>
      <span>Rezept löschen</span>
    </button>
    <div class="flex space-x-3">
      <button 
        type="button" 
        id="cancel-edit-btn-desktop"
        class="px-6 py-3 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
      >
        Abbrechen
      </button>
      <!-- Save as variant button (desktop) -->
      <button 
        type="button" 
        id="save-as-variant-btn-bottom"
        class="px-6 py-3 bg-indigo-500 hover:bg-indigo-600 text-white rounded-md transition-colors flex items-center space-x-2"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4h9v9H4zM9 9h9v9H9z"/>
        </svg>
        <span>Als Variante speichern</span>
      </button>
      <!-- Save button at bottom (desktop) -->
      <button 
        type="button" 
        id="save-btn-bottom"
        class="px-6 py-3 bg-green-500 hover:bg-green-600 text-white rounded-md transition-colors flex items-center space-x-2"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
        <span>Speichern</span>
      </button>
    </div>
  </div>
    </>
  )}
</div>

<script define:vars={{ isVariantDraft, parentRecipeId }}>
  const form = document.getElementById('edit-recipe-form');
  const saveBtn = document.getElementById('save-btn');
  const saveBtnMobile = document.getElementById('save-btn-mobile');
  const saveBtnBottom = document.getElementById('save-btn-bottom');
  const saveBtnBottomMobile = document.getElementById('save-btn-bottom-mobile');
  const saveAsVariantBtn = document.getElementById('save-as-variant-btn-bottom');
  const saveAsVariantBtnMobile = document.getElementById('save-as-variant-btn-mobile');

  if (isVariantDraft && parentRecipeId) {
    const runSave = () => {
      const variantName = window.__VARIANT_DRAFT_NAME__;
      const createVariant = window.createRecipeVariant;
      if (typeof createVariant === 'function' && variantName !== undefined) {
        createVariant(variantName);
      }
    };
    const runCancel = () => {
      window.location.href = `/rezept/${parentRecipeId}`;
    };
    [
      document.getElementById('save-variant-draft-btn-mobile'),
      document.getElementById('save-variant-draft-btn-desktop'),
    ].forEach((btn) => btn?.addEventListener('click', runSave));
    [
      document.getElementById('cancel-variant-draft-btn-mobile'),
      document.getElementById('cancel-variant-draft-btn-desktop'),
    ].forEach((btn) => btn?.addEventListener('click', runCancel));
  } else {
    [saveBtn, saveBtnMobile, saveBtnBottom, saveBtnBottomMobile].forEach(btn => {
      btn?.addEventListener('click', () => {
        [saveBtn, saveBtnMobile, saveBtnBottom, saveBtnBottomMobile].forEach(button => {
          if (button) {
            const span = button.querySelector('span');
            const svg = button.querySelector('svg');
            button.disabled = true;
            if (span) span.textContent = 'Speichert...';
            if (svg) svg.style.display = 'none';
          }
        });
        form?.dispatchEvent(new Event('submit'));
      });
    });
    [saveAsVariantBtn, saveAsVariantBtnMobile].forEach(btn => {
      btn?.addEventListener('click', () => {
        const openVariant = window.openVariantModal;
        if (typeof openVariant === 'function') openVariant();
      });
    });
  }
</script> 