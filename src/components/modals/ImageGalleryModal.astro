---
// Image gallery for TinyMCE: pick from recipe images or images from other notes.
// Parent page opens via openImageGalleryModal(), sets window.__onGalleryImageSelect before opening.
// On image click we call window.__onGalleryImageSelect(url) and close.
---

<div id="image-gallery-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60]">
  <div class="modal-overlay absolute inset-0" data-close="image-gallery-modal"></div>
  <div class="modal-content modal-wide mx-4 bg-white dark:bg-gray-800 rounded-lg shadow-xl relative max-h-[85vh] flex flex-col">
    <div class="modal-header flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
      <h2 class="modal-title text-lg font-medium text-gray-900 dark:text-white">Bild aus Galerie wählen</h2>
      <button type="button" class="modal-close text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-2xl leading-none" data-close="image-gallery-modal" aria-label="Schließen">&times;</button>
    </div>
    <div class="modal-body p-4 overflow-y-auto flex-1">
      <div id="image-gallery-loading" class="text-center py-8">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500"></div>
        <p class="text-muted mt-2">Galerie wird geladen...</p>
      </div>
      <div id="image-gallery-content" class="hidden space-y-6">
        <section id="image-gallery-recipes">
          <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Aus Rezepten</h3>
          <div id="image-gallery-recipes-grid" class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 gap-3">
            <!-- Filled by JS -->
          </div>
          <p id="image-gallery-recipes-empty" class="hidden text-sm text-muted">Keine Rezeptbilder vorhanden.</p>
        </section>
        <section id="image-gallery-notes">
          <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Aus anderen Notizen</h3>
          <div id="image-gallery-notes-grid" class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 gap-3">
            <!-- Filled by JS -->
          </div>
          <p id="image-gallery-notes-empty" class="hidden text-sm text-muted">Keine Bilder aus Notizen vorhanden.</p>
        </section>
      </div>
    </div>
    <div class="modal-footer p-4 border-t border-gray-200 dark:border-gray-700">
      <button type="button" class="btn btn-secondary modal-close" data-close="image-gallery-modal">Abbrechen</button>
    </div>
  </div>
</div>

<script>
  // @ts-nocheck
  (function () {
    const modal = document.getElementById('image-gallery-modal');
    const loading = document.getElementById('image-gallery-loading');
    const content = document.getElementById('image-gallery-content');
    const recipesGrid = document.getElementById('image-gallery-recipes-grid');
    const notesGrid = document.getElementById('image-gallery-notes-grid');
    const recipesEmpty = document.getElementById('image-gallery-recipes-empty');
    const notesEmpty = document.getElementById('image-gallery-notes-empty');

    function closeGallery() {
      if (modal) modal.classList.add('hidden');
      document.body.style.overflow = '';
    }

    function selectImage(url) {
      if (typeof window.__onGalleryImageSelect === 'function') {
        window.__onGalleryImageSelect(url);
      }
      closeGallery();
    }

    window.openImageGalleryModal = function () {
      if (!modal) return;
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      if (loading) loading.classList.remove('hidden');
      if (content) content.classList.add('hidden');
      if (recipesGrid) recipesGrid.innerHTML = '';
      if (notesGrid) notesGrid.innerHTML = '';
      if (recipesEmpty) recipesEmpty.classList.add('hidden');
      if (notesEmpty) notesEmpty.classList.add('hidden');

      fetch('/api/images/gallery')
        .then((res) => res.ok ? res.json() : Promise.reject(new Error('Failed to load gallery')))
        .then((data) => {
          if (loading) loading.classList.add('hidden');
          if (content) content.classList.remove('hidden');

          const recipeImages = data.recipeImages || [];
          const noteImages = data.noteImages || [];

          if (recipesGrid) {
            recipeImages.forEach((item) => {
              const btn = document.createElement('button');
              btn.type = 'button';
              btn.className = 'block w-full aspect-square rounded-lg overflow-hidden border-2 border-transparent hover:border-orange-500 dark:hover:border-orange-400 focus:outline-none focus:ring-2 focus:ring-orange-500 bg-gray-100 dark:bg-gray-700';
              btn.title = item.recipeTitle || item.url;
              const img = document.createElement('img');
              img.src = item.url;
              img.alt = '';
              img.className = 'w-full h-full object-cover';
              img.loading = 'lazy';
              img.onerror = () => { btn.disabled = true; btn.classList.add('opacity-50'); };
              btn.appendChild(img);
              btn.addEventListener('click', () => selectImage(item.url));
              recipesGrid.appendChild(btn);
            });
          }
          if (recipesEmpty) recipesEmpty.classList.toggle('hidden', recipeImages.length > 0);

          if (notesGrid) {
            noteImages.forEach((item) => {
              const btn = document.createElement('button');
              btn.type = 'button';
              btn.className = 'block w-full aspect-square rounded-lg overflow-hidden border-2 border-transparent hover:border-orange-500 dark:hover:border-orange-400 focus:outline-none focus:ring-2 focus:ring-orange-500 bg-gray-100 dark:bg-gray-700';
              const img = document.createElement('img');
              img.src = item.url;
              img.alt = '';
              img.className = 'w-full h-full object-cover';
              img.loading = 'lazy';
              img.onerror = () => { btn.disabled = true; btn.classList.add('opacity-50'); };
              btn.appendChild(img);
              btn.addEventListener('click', () => selectImage(item.url));
              notesGrid.appendChild(btn);
            });
          }
          if (notesEmpty) notesEmpty.classList.toggle('hidden', noteImages.length > 0);
        })
        .catch(() => {
          if (loading) loading.classList.add('hidden');
          if (content) content.classList.remove('hidden');
          if (recipesGrid) recipesGrid.innerHTML = '<p class="col-span-full text-sm text-red-600 dark:text-red-400">Galerie konnte nicht geladen werden.</p>';
        });
    };

    document.addEventListener('click', (e) => {
      const t = (e.target && 'closest' in e.target) ? e.target.closest('[data-close="image-gallery-modal"]') : null;
      if (t) { e.preventDefault(); closeGallery(); }
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal && !modal.classList.contains('hidden')) {
        closeGallery();
        e.preventDefault();
      }
    });
  })();
</script>
