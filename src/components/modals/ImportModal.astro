---
declare global {
  interface Window {
    openImportModal?: () => void;
    showSuccess?: (message: string) => Promise<void>;
    showError?: (message: string) => Promise<void>;
    showWarnings?: (warnings: string[], onContinue: () => void) => void;
  }
}
---

<!-- Import/Export Modal -->
<div id="import-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 shadow-xl">
    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Rezepte importieren</h3>
    
    <!-- Import Type Selector -->
    <div class="mb-4">
      <div class="flex border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-700">
        <button id="import-file-tab" class="flex-1 px-4 py-2 text-sm font-medium text-gray-900 dark:text-white bg-white dark:bg-gray-800 rounded-l-lg border-r border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:bg-orange-50 dark:focus:bg-orange-900/50 transition-colors">
          Datei
        </button>
        <button id="import-url-tab" class="flex-1 px-4 py-2 text-sm font-medium text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-700 border-r border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:bg-orange-50 dark:focus:bg-orange-900/50 transition-colors">
          URL
        </button>
        <button id="import-text-tab" class="flex-1 px-4 py-2 text-sm font-medium text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-700 rounded-r-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:bg-orange-50 dark:focus:bg-orange-900/50 transition-colors">
          Text
        </button>
      </div>
    </div>
    
    <!-- File Import Content -->
    <div id="import-file-content">
      <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 text-center hover:border-orange-400 dark:hover:border-orange-500 transition-colors">
        <svg class="mx-auto h-12 w-12 text-gray-400 dark:text-gray-500" stroke="currentColor" fill="none" viewBox="0 0 48 48">
          <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3-3m-3 3l3 3m-3-3H21" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <div class="mt-4">
          <label for="file-upload" class="cursor-pointer">
            <span class="mt-2 block text-sm font-medium text-gray-900 dark:text-white">
              Datei auswählen oder hier ablegen
            </span>
            <span class="mt-1 block text-xs text-gray-500 dark:text-gray-400">
              JSON oder RCB Dateien (.json, .rcb)
            </span>
          </label>
          <input id="file-upload" name="file-upload" type="file" accept=".json,.rcb" class="sr-only">
        </div>
      </div>
    </div>
    
    <!-- URL Import Content -->
    <div id="import-url-content" class="hidden">
      <div class="space-y-4">
        <div>
          <label for="recipe-url" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Rezept-URL eingeben
          </label>
          <input 
            type="url" 
            id="recipe-url" 
            placeholder="https://www.chefkoch.de/rezepte/..." 
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 dark:bg-gray-700 dark:text-white"
          >
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
            Unterstützt: Chefkoch.de, Lecker.de und viele andere Websites mit Rezept-Daten
          </p>
        </div>
        <div id="url-preview" class="hidden p-4 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600">
          <div class="space-y-3">
            <div class="text-sm text-gray-600 dark:text-gray-300">
              <strong>Erkannte Website:</strong> <span id="detected-site" class="text-orange-600 dark:text-orange-400"></span>
            </div>
            
            <div id="extractor-details" class="text-sm text-gray-600 dark:text-gray-300">
              <div class="font-medium mb-2">Extraktor-Funktionen:</div>
              <div class="grid grid-cols-2 gap-2 text-xs">
                <div class="flex items-center space-x-2">
                  <span id="ingredient-groups-support" class="w-3 h-3 rounded-full bg-gray-400"></span>
                  <span id="ingredient-groups-support-title">Zutatengruppen</span>
                </div>
                <div class="flex items-center space-x-2">
                  <span id="preparation-groups-support" class="w-3 h-3 rounded-full bg-gray-400"></span>
                  <span id="preparation-groups-support-title">Zubereitungsgruppen</span>
                </div>
                <div class="flex items-center space-x-2">
                  <span id="images-support" class="w-3 h-3 rounded-full bg-gray-400"></span>
                  <span id="images-support-title">Bilder</span>
                </div>
                <div class="flex items-center space-x-2">
                  <span id="nutrition-support" class="w-3 h-3 rounded-full bg-gray-400"></span>
                  <span id="nutrition-support-title">Nährwerte</span>
                </div>
                <div class="flex items-center space-x-2">
                  <span id="metadata-support" class="w-3 h-3 rounded-full bg-gray-400"></span>
                  <span id="metadata-support-title">Metadaten</span>
                </div>
                <div class="flex items-center space-x-2">
                  <span id="keywords-support" class="w-3 h-3 rounded-full bg-gray-400"></span>
                  <span id="keywords-support-title">Keywords</span>
                </div>
                <div class="flex items-center space-x-2">
                  <span id="category-support" class="w-3 h-3 rounded-full bg-gray-400"></span>
                  <span id="category-support-title">Kategorie</span>
                </div>
                <div class="flex items-center space-x-2">
                  <span id="difficulty-support" class="w-3 h-3 rounded-full bg-gray-400"></span>
                  <span id="difficulty-support-title">Schwierigkeit</span>
                </div>
                <div class="flex items-center space-x-2">
                  <span id="time-support" class="w-3 h-3 rounded-full bg-gray-400"></span>
                  <span id="time-support-title">Zeit-Extraktion</span>
                </div>
              </div>
              <div id="extractor-description" class="mt-2 text-xs text-gray-500 dark:text-gray-400 italic"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Text Import Content -->
    <div id="import-text-content" class="hidden">
      <div class="space-y-4">
        <div>
          <label for="recipe-text" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Rezept-JSON eingeben
          </label>
          <textarea 
            id="recipe-text" 
            rows="12"
            placeholder='{"title": "Rezeptname", "ingredientGroups": [...], ...}' 
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 dark:bg-gray-700 dark:text-white font-mono text-sm"
          ></textarea>
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
            Fügen Sie hier direkt den JSON-Code für ein oder mehrere Rezepte ein
          </p>
        </div>
      </div>
    </div>
    
    <div class="mt-6 flex justify-end space-x-3">
      <button id="cancel-import" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">Abbrechen</button>
      <button id="confirm-import" class="px-4 py-2 text-sm font-medium text-white bg-orange-500 border border-transparent rounded-md hover:bg-orange-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>Importieren</button>
    </div>
  </div>
</div>

<script>
  // Import functionality
  const importModal = document.getElementById('import-modal');
  const fileUpload = document.getElementById('file-upload');
  const cancelImport = document.getElementById('cancel-import');
  const confirmImport = document.getElementById('confirm-import');
  
  // Tab elements
  const importFileTab = document.getElementById('import-file-tab');
  const importUrlTab = document.getElementById('import-url-tab');
  const importTextTab = document.getElementById('import-text-tab');
  const importFileContent = document.getElementById('import-file-content');
  const importUrlContent = document.getElementById('import-url-content');
  const importTextContent = document.getElementById('import-text-content');
  
  // URL elements
  const recipeUrl = document.getElementById('recipe-url') as HTMLInputElement;
  const urlPreview = document.getElementById('url-preview');
  const detectedSite = document.getElementById('detected-site');
  
  // Text elements
  const recipeText = document.getElementById('recipe-text') as HTMLTextAreaElement;
  
  let selectedFile: File | null = null;
  let currentImportType: 'file' | 'url' | 'text' = 'file';
  let supportedSites: any[] = [];

  // Load supported sites
  loadSupportedSites();

  // Open modal when import button is clicked (handled externally)
  // The import button is in RecipeListHeader, so we expose a function to open the modal
  window.openImportModal = () => {
    importModal?.classList.remove('hidden');
    setImportType('file');
  };

  cancelImport?.addEventListener('click', () => {
    importModal?.classList.add('hidden');
    resetImportModal();
  });

  // Tab switching
  importFileTab?.addEventListener('click', () => setImportType('file'));
  importUrlTab?.addEventListener('click', () => setImportType('url'));
  importTextTab?.addEventListener('click', () => setImportType('text'));

  // File upload
  fileUpload?.addEventListener('change', (e) => {
    const target = e.target as HTMLInputElement;
    if (target.files && target.files[0]) {
      selectedFile = target.files[0];
      updateImportButton();
      updateFileDisplay();
    }
  });

  // URL input
  recipeUrl?.addEventListener('input', async (e) => {
    const target = e.target as HTMLInputElement;
    const url = target.value.trim();
    
    if (url) {
      await updateUrlPreview(url);
      updateImportButton();
    } else {
      hideUrlPreview();
      updateImportButton();
    }
  });

  // Text input
  recipeText?.addEventListener('input', () => {
    updateImportButton();
  });

  confirmImport?.addEventListener('click', async () => {
    if (currentImportType === 'file') {
      await handleFileImport();
    } else if (currentImportType === 'url') {
      await handleUrlImport();
    } else {
      await handleTextImport();
    }
  });

  function setImportType(type: 'file' | 'url' | 'text') {
    currentImportType = type;
    
    // Reset all tabs
    [importFileTab, importUrlTab, importTextTab].forEach(tab => {
      if (tab) {
        tab.classList.add('text-gray-500', 'dark:text-gray-400', 'bg-gray-50', 'dark:bg-gray-700');
        tab.classList.remove('text-gray-900', 'dark:text-white', 'bg-white', 'dark:bg-gray-800');
      }
    });
    
    // Hide all content
    importFileContent?.classList.add('hidden');
    importUrlContent?.classList.add('hidden');
    importTextContent?.classList.add('hidden');
    
    if (type === 'file') {
      // Activate file tab
      importFileTab?.classList.add('text-gray-900', 'dark:text-white', 'bg-white', 'dark:bg-gray-800');
      importFileTab?.classList.remove('text-gray-500', 'dark:text-gray-400', 'bg-gray-50', 'dark:bg-gray-700');
      importFileContent?.classList.remove('hidden');
    } else if (type === 'url') {
      // Activate URL tab
      importUrlTab?.classList.add('text-gray-900', 'dark:text-white', 'bg-white', 'dark:bg-gray-800');
      importUrlTab?.classList.remove('text-gray-500', 'dark:text-gray-400', 'bg-gray-50', 'dark:bg-gray-700');
      importUrlContent?.classList.remove('hidden');
    } else {
      // Activate text tab
      importTextTab?.classList.add('text-gray-900', 'dark:text-white', 'bg-white', 'dark:bg-gray-800');
      importTextTab?.classList.remove('text-gray-500', 'dark:text-gray-400', 'bg-gray-50', 'dark:bg-gray-700');
      importTextContent?.classList.remove('hidden');
    }
    
    updateImportButton();
  }

  async function loadSupportedSites() {
    try {
      const response = await fetch('/api/recipes/import/url');
      if (response.ok) {
        const data = await response.json();
        supportedSites = data.supportedSites || [];
      }
    } catch (error) {
      console.error('Failed to load supported sites:', error);
    }
  }

  async function updateUrlPreview(url: string) {
    try {
      new URL(url); // Validate URL format first
      
      // Get extractor preview information
      const response = await fetch('/api/recipes/import/preview', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ url })
      });
      
      if (response.ok) {
        const data = await response.json();
        
        // Update extractor name
        if (detectedSite) {
          detectedSite.textContent = data.extractorName;
        }
        
        // Update capabilities
        updateCapabilityIndicator('ingredient-groups-support', data.capabilities.supportsIngredientGroups);
        updateCapabilityIndicator('preparation-groups-support', data.capabilities.supportsPreparationGroups);
        updateCapabilityIndicator('images-support', data.capabilities.supportsImages);
        updateCapabilityIndicator('nutrition-support', data.capabilities.supportsNutrition);
        updateCapabilityIndicator('metadata-support', data.capabilities.supportsMetadata);
        updateCapabilityIndicator('keywords-support', data.capabilities.supportsKeywordExtraction);
        updateCapabilityIndicator('category-support', data.capabilities.supportsCategoryExtraction);
        updateCapabilityIndicator('difficulty-support', data.capabilities.supportsDifficultyExtraction);
        updateCapabilityIndicator('time-support', data.capabilities.supportsTimeExtraction);
        
        // Update description
        const descriptionElement = document.getElementById('extractor-description');
        if (descriptionElement) {
          descriptionElement.textContent = data.description;
        }
        
        urlPreview?.classList.remove('hidden');
      } else {
        // Fallback to simple domain detection
        const urlObj = new URL(url);
        const domain = urlObj.hostname.toLowerCase();
        
        const matchingSite = supportedSites.find(site => 
          site.domains.some((d: string) => 
            domain === d || domain.endsWith(`.${d}`) || domain.includes(d)
          )
        );
        
        if (detectedSite) {
          detectedSite.textContent = matchingSite ? matchingSite.name : 'Allgemeine Website (JSON-LD Fallback)';
        }
        
        // Set default capabilities for fallback
        updateCapabilityIndicator('ingredient-groups-support', { value: false, title: 'Zutatengruppen' });
        updateCapabilityIndicator('preparation-groups-support', { value: false, title: 'Vorbereitungsschritte' });
        updateCapabilityIndicator('images-support', { value: true, title: 'Bilder' });
        updateCapabilityIndicator('nutrition-support', { value: false, title: 'Nährwerte' });
        updateCapabilityIndicator('metadata-support', { value: true, title: 'Metadaten' });
        updateCapabilityIndicator('keywords-support', { value: true, title: 'Schlüsselwörter' });
        updateCapabilityIndicator('category-support', { value: true, title: 'Kategorien' });
        updateCapabilityIndicator('difficulty-support', { value: false, title: 'Schwierigkeit' });
        updateCapabilityIndicator('time-support', { value: false, title: 'Zeit-Extraktion' });
        
        const descriptionElement = document.getElementById('extractor-description');
        if (descriptionElement) {
          descriptionElement.textContent = 'Basis-Funktionalität verfügbar';
        }
        
        urlPreview?.classList.remove('hidden');
      }
    } catch (error) {
      console.error('Error updating URL preview:', error);
      hideUrlPreview();
    }
  }

  function updateCapabilityIndicator(elementId: string, capability: { value: boolean | string; title: string }) {
    const element = document.getElementById(elementId);
    if (element) {
      if (capability.value === 'experimental') {
        element.className = 'w-3 h-3 rounded-full bg-yellow-500';
      } else {
        element.className = `w-3 h-3 rounded-full ${
          capability.value 
            ? 'bg-green-500' 
            : 'bg-gray-400'
        }`;
      }
    }
    const titleElement = document.getElementById(`${elementId}-title`);
    if (titleElement) {
      titleElement.textContent = capability.title;
    }
  }

  function hideUrlPreview() {
    urlPreview?.classList.add('hidden');
  }

  async function handleUrlImport() {
    const url = recipeUrl?.value.trim();
    if (!url) return;

    // Show loading state
    if (confirmImport) {
      (confirmImport as HTMLButtonElement).disabled = true;
      (confirmImport as HTMLButtonElement).textContent = 'Importiere...';
    }

    try {
      const response = await fetch('/api/recipes/import/url', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ url })
      });

      const result = await response.json();

      if (response.ok) {
        // Hide import modal
        importModal?.classList.add('hidden');
        
        // Show success message
        if (window.showSuccess) {
          await window.showSuccess(`Erfolgreich Rezept "${result.recipe.title}" importiert mit ${result.extractorUsed}!`);
        }

        // Show warnings if any and redirect after confirmation
        if (result.warnings && result.warnings.length > 0) {
          if (window.showWarnings) {
            window.showWarnings(result.warnings, () => {
              if (result.recipeId) {
                window.location.href = `/rezept/${result.recipeId}`;
              } else {
                window.location.reload();
              }
            });
          } else {
            // Fallback: redirect immediately if showWarnings is not available
            if (result.recipeId) {
              window.location.href = `/rezept/${result.recipeId}`;
            } else {
              window.location.reload();
            }
          }
        } else {
          // No warnings, redirect immediately
          if (result.recipeId) {
            window.location.href = `/rezept/${result.recipeId}`;
          } else {
            window.location.reload();
          }
        }
      } else {
        if (window.showError) {
          window.showError(`Import fehlgeschlagen: ${result.error}`);
        } else {
          alert(`Import fehlgeschlagen: ${result.error}`);
        }
      }
    } catch (error) {
      if (window.showError) {
        window.showError(`Import fehlgeschlagen: ${error}`);
      } else {
        alert(`Import fehlgeschlagen: ${error}`);
      }
    }

    // Reset loading state
    if (confirmImport) {
      (confirmImport as HTMLButtonElement).disabled = false;
      (confirmImport as HTMLButtonElement).textContent = 'Importieren';
    }

    resetImportModal();
  }

  async function handleFileImport() {
    if (!selectedFile) return;

    try {
      const formData = new FormData();
      formData.append('file', selectedFile);

      const response = await fetch('/api/recipes/import', {
        method: 'POST',
        body: formData
      });

      const result = await response.json();

      if (response.ok) {
        const imageInfo = result.totalImages ? ` (mit ${result.totalImages} Bild(ern))` : '';
        
        if (result.imported === 1 && result.recipeId) {
          // Single recipe imported - redirect to recipe page
          if (window.showSuccess) {
            await window.showSuccess(`Erfolgreich Rezept importiert${imageInfo}!`);
          }
          window.location.href = `/rezept/${result.recipeId}`;
        } else {
          // Multiple recipes imported - stay on recipe list
          if (window.showSuccess) {
            await window.showSuccess(`Erfolgreich ${result.imported} Rezept(e) importiert${imageInfo}!`);
          }
          window.location.reload();
        }
      } else {
        if (window.showError) {
          window.showError(`Import fehlgeschlagen: ${result.error}`);
        } else {
          alert(`Import fehlgeschlagen: ${result.error}`);
        }
      }
    } catch (error) {
      if (window.showError) {
        window.showError(`Import fehlgeschlagen: ${error}`);
      } else {
        alert(`Import fehlgeschlagen: ${error}`);
      }
    }

    // Reset loading state
    if (confirmImport) {
      (confirmImport as HTMLButtonElement).disabled = false;
      (confirmImport as HTMLButtonElement).textContent = 'Importieren';
    }

    resetImportModal();
  }

  async function handleTextImport() {
    const text = recipeText?.value.trim();
    if (!text) return;

    // Show loading state
    if (confirmImport) {
      (confirmImport as HTMLButtonElement).disabled = true;
      (confirmImport as HTMLButtonElement).textContent = 'Importiere...';
    }

    try {
      // Validate JSON first - this will throw SyntaxError if invalid
      JSON.parse(text);

      const response = await fetch('/api/recipes/import/text', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ text })
      });

      // Parse response JSON - this might also throw SyntaxError
      let result;
      try {
        result = await response.json();
      } catch (parseError) {
        // Response is not valid JSON
        if (window.showError) {
          window.showError(`Ungültige Server-Antwort: Die Antwort konnte nicht als JSON gelesen werden.`);
        } else {
          alert(`Ungültige Server-Antwort: Die Antwort konnte nicht als JSON gelesen werden.`);
        }
        return;
      }

      if (response.ok) {
        const imageInfo = result.totalImages ? ` (mit ${result.totalImages} Bild(ern))` : '';
        
        // Hide import modal
        importModal?.classList.add('hidden');
        
        if (result.imported === 1 && result.recipeId) {
          // Single recipe imported - redirect to recipe page
          if (window.showSuccess) {
            await window.showSuccess(`Erfolgreich Rezept importiert${imageInfo}!`);
          }
          window.location.href = `/rezept/${result.recipeId}`;
        } else {
          // Multiple recipes imported - stay on recipe list
          if (window.showSuccess) {
            await window.showSuccess(`Erfolgreich ${result.imported} Rezept(e) importiert${imageInfo}!`);
          }
          window.location.reload();
        }
      } else {
        // Server returned an error response
        if (window.showError) {
          window.showError(`Import fehlgeschlagen: ${result.error || 'Unbekannter Fehler'}`);
        } else {
          alert(`Import fehlgeschlagen: ${result.error || 'Unbekannter Fehler'}`);
        }
      }
    } catch (error) {
      // Handle different types of errors
      if (error instanceof SyntaxError) {
        // This is a JSON parse error from user input (line 530)
        if (window.showError) {
          window.showError(`Ungültiges JSON-Format: ${error.message}`);
        } else {
          alert(`Ungültiges JSON-Format: ${error.message}`);
        }
      } else if (error instanceof TypeError && error.message.includes('fetch')) {
        // Network error
        if (window.showError) {
          window.showError(`Netzwerkfehler: ${error.message}`);
        } else {
          alert(`Netzwerkfehler: ${error.message}`);
        }
      } else {
        // Other errors (shouldn't happen, but handle gracefully)
        if (window.showError) {
          window.showError(`Import fehlgeschlagen: ${error instanceof Error ? error.message : String(error)}`);
        } else {
          alert(`Import fehlgeschlagen: ${error instanceof Error ? error.message : String(error)}`);
        }
      }
    } finally {
      // Reset loading state
      if (confirmImport) {
        (confirmImport as HTMLButtonElement).disabled = false;
        (confirmImport as HTMLButtonElement).textContent = 'Importieren';
      }

      resetImportModal();
    }
  }

  function resetImportModal() {
    // Reset file upload
    selectedFile = null;
    if (fileUpload) {
      (fileUpload as HTMLInputElement).value = '';
    }
    
    // Reset URL input
    if (recipeUrl) {
      recipeUrl.value = '';
    }
    hideUrlPreview();
    
    // Reset text input
    if (recipeText) {
      recipeText.value = '';
    }
    
    // Reset import button
    updateImportButton();
    
    // Reset to file tab
    setImportType('file');
    
    // Hide modals
    importModal?.classList.add('hidden');
    document.getElementById('warning-modal')?.classList.add('hidden');
  }

  function updateImportButton() {
    if (!confirmImport) return;
    
    const button = confirmImport as HTMLButtonElement;
    if (currentImportType === 'file') {
      button.disabled = !selectedFile;
    } else if (currentImportType === 'url') {
      button.disabled = !recipeUrl?.value.trim();
    } else {
      button.disabled = !recipeText?.value.trim();
    }
  }

  function updateFileDisplay() {
    const dropText = document.querySelector('#import-file-content .text-sm');
    if (dropText && selectedFile) {
      dropText.textContent = selectedFile.name;
    }
  }

  // Close modal when clicking outside
  importModal?.addEventListener('click', (e) => {
    if (e.target === importModal) {
      importModal.classList.add('hidden');
      resetImportModal();
    }
  });
</script>

