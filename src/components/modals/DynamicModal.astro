---
interface Props {
  id?: string;
  size?: 'sm' | 'md' | 'lg' | 'xl';
}

const { id = 'dynamic-modal', size = 'md' } = Astro.props;

const sizeClasses = {
  sm: 'max-w-sm',
  md: 'max-w-md', 
  lg: 'max-w-lg',
  xl: 'max-w-2xl'
};
---

<!-- Modal Backdrop -->
<div id={id} class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 transition-all duration-200">
  <div class={`bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full mx-4 transition-all duration-200 ${sizeClasses[size]}`}>
    <!-- Modal Header -->
    <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700">
      <h3 id={`${id}-title`} class="text-lg font-medium text-gray-900 dark:text-white">
        <!-- Title will be set dynamically -->
      </h3>
      <button id={`${id}-close`} class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
    
    <!-- Modal Body -->
    <div class="p-6">
      <div id={`${id}-content`} class="text-gray-700 dark:text-gray-300">
        <!-- Content will be set dynamically -->
      </div>
    </div>
    
    <!-- Modal Footer -->
    <div id={`${id}-footer`} class="flex items-center justify-end space-x-3 p-6 border-t border-gray-200 dark:border-gray-700">
      <!-- Buttons will be added dynamically -->
    </div>
  </div>
</div>

<script define:vars={{ id }}>
  // Modal functionality
  class DynamicModal {
    constructor(modalId) {
      this.modalId = modalId;
      this.modal = document.getElementById(modalId);
      this.titleElement = document.getElementById(`${modalId}-title`);
      this.contentElement = document.getElementById(`${modalId}-content`);
      this.footerElement = document.getElementById(`${modalId}-footer`);
      this.closeButton = document.getElementById(`${modalId}-close`);
      
      this.setupEventListeners();
    }
    
    setupEventListeners() {
      // Close button
      this.closeButton?.addEventListener('click', () => this.hide());
      
      // Click outside to close
      this.modal?.addEventListener('click', (e) => {
        if (e.target === this.modal) {
          this.hide();
        }
      });
      
      // Escape key to close
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !this.modal?.classList.contains('hidden')) {
          this.hide();
        }
      });
      
      // Listen for theme changes (localStorage event)
      window.addEventListener('storage', (e) => {
        if (e.key === 'color-theme') {
          // Theme has changed in another tab, update our modal if visible
          if (!this.modal?.classList.contains('hidden')) {
            // Force a repaint to apply the new theme
            this.modal.style.opacity = '0.99';
            setTimeout(() => {
              this.modal.style.opacity = '1';
            }, 10);
          }
        }
      });
      
      // Listen for theme changes within the same page
      document.addEventListener('themeChanged', () => {
        // Update our modal if visible
        if (!this.modal?.classList.contains('hidden')) {
          // Force a repaint to apply the new theme
          this.modal.style.opacity = '0.99';
          setTimeout(() => {
            this.modal.style.opacity = '1';
          }, 10);
        }
      });
    }
    
    show(options = {}) {
      const {
        title = '',
        content = '',
        buttons = [{ text: 'OK', type: 'primary', action: () => this.hide() }],
        icon = null
      } = options;
      
      // Set title
      if (this.titleElement) {
        this.titleElement.innerHTML = title;
      }
      
      // Set content with optional icon
      if (this.contentElement) {
        let contentHTML = '';
        if (icon) {
          contentHTML += `<div class="flex items-start space-x-3">`;
          contentHTML += `<div class="flex-shrink-0">${icon}</div>`;
          contentHTML += `<div class="flex-1">${content}</div>`;
          contentHTML += `</div>`;
        } else {
          contentHTML = content;
        }
        this.contentElement.innerHTML = contentHTML;
      }
      
      // Set buttons
      if (this.footerElement) {
        this.footerElement.innerHTML = '';
        buttons.forEach(button => {
          const btn = document.createElement('button');
          btn.textContent = button.text;
          btn.className = this.getButtonClasses(button.type || 'secondary');
          btn.addEventListener('click', button.action || (() => this.hide()));
          this.footerElement.appendChild(btn);
        });
      }
      
      // Show modal
      this.modal?.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }
    
    hide() {
      this.modal?.classList.add('hidden');
      document.body.style.overflow = '';
    }
    
    getButtonClasses(type) {
      const baseClasses = 'btn';
      
      switch (type) {
        case 'primary':
          return `${baseClasses} btn-primary`;
        case 'success':
          return `${baseClasses} btn-success`;
        case 'danger':
          return `${baseClasses} btn-danger`;
        case 'secondary':
        default:
          return `${baseClasses} btn-secondary`;
      }
    }
  }
  
  // Initialize modal
  window[`modal_${id}`] = new DynamicModal(id);
</script>

<style>
  /* Smooth transitions */
  #dynamic-modal {
    transition: opacity 0.2s ease-out;
  }
  
  #dynamic-modal.hidden {
    opacity: 0;
    pointer-events: none;
  }
  
  #dynamic-modal:not(.hidden) {
    opacity: 1;
  }
</style> 