---
interface Props {
  recipeCount: number;
}

const { recipeCount } = Astro.props;
---

<div class="flex-between">
  <div>
    <h1 class="heading-primary">Meine Rezepte</h1>
    <p class="text-muted mt-1">{recipeCount} Rezepte gefunden</p>
  </div>
  <div class="flex space-x-3">
    <!-- Import Button -->
    <button id="import-btn" class="btn btn-secondary flex items-center space-x-2">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
      </svg>
      <span>Importieren</span>
    </button>
    
    <!-- Export Dropdown -->
    <div class="relative export-dropdown">
      <button id="export-btn" class="btn btn-secondary flex items-center space-x-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
        </svg>
        <span>Exportieren</span>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
        </svg>
      </button>
      <div id="export-menu" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg border border-gray-200 hidden z-10">
        <div class="py-1">
          <button id="export-json" class="flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            JSON (ohne Bilder)
          </button>
          <button id="export-rcb" class="flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
            </svg>
            Vollständig (mit Bildern)
          </button>
        </div>
      </div>
    </div>
    
    <button class="btn btn-secondary flex items-center space-x-2">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
      </svg>
      <span>Suchen</span>
    </button>
    <button class="btn btn-secondary flex items-center space-x-2">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.707A1 1 0 013 7V4z"/>
      </svg>
      <span>Filter</span>
    </button>
  </div>
</div>

<!-- Hidden file input for import -->
<input type="file" id="import-file" accept=".json,.rcb" style="display: none;">

<!-- Import/Export Modal -->
<div id="import-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 shadow-xl">
    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Rezepte importieren</h3>
    
    <!-- Import Type Selector -->
    <div class="mb-4">
      <div class="flex border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-700">
        <button id="import-file-tab" class="flex-1 px-4 py-2 text-sm font-medium text-gray-900 dark:text-white bg-white dark:bg-gray-800 rounded-l-lg border-r border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:bg-orange-50 dark:focus:bg-orange-900/50 transition-colors">
          Datei
        </button>
        <button id="import-url-tab" class="flex-1 px-4 py-2 text-sm font-medium text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-700 rounded-r-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:bg-orange-50 dark:focus:bg-orange-900/50 transition-colors">
          URL
        </button>
      </div>
    </div>
    
    <!-- File Import Content -->
    <div id="import-file-content">
      <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 text-center hover:border-orange-400 dark:hover:border-orange-500 transition-colors">
        <svg class="mx-auto h-12 w-12 text-gray-400 dark:text-gray-500" stroke="currentColor" fill="none" viewBox="0 0 48 48">
          <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3-3m-3 3l3 3m-3-3H21" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <div class="mt-4">
          <label for="file-upload" class="cursor-pointer">
            <span class="mt-2 block text-sm font-medium text-gray-900 dark:text-white">
              Datei auswählen oder hier ablegen
            </span>
            <span class="mt-1 block text-xs text-gray-500 dark:text-gray-400">
              JSON oder RCB Dateien (.json, .rcb)
            </span>
          </label>
          <input id="file-upload" name="file-upload" type="file" accept=".json,.rcb" class="sr-only">
        </div>
      </div>
    </div>
    
    <!-- URL Import Content -->
    <div id="import-url-content" class="hidden">
      <div class="space-y-4">
        <div>
          <label for="recipe-url" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Rezept-URL eingeben
          </label>
          <input 
            type="url" 
            id="recipe-url" 
            placeholder="https://www.chefkoch.de/rezepte/..." 
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 dark:bg-gray-700 dark:text-white"
          >
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
            Unterstützt: Chefkoch.de, Lecker.de und viele andere Websites mit Rezept-Daten
          </p>
        </div>
        <div id="url-preview" class="hidden p-4 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600">
          <div class="space-y-3">
            <div class="text-sm text-gray-600 dark:text-gray-300">
              <strong>Erkannte Website:</strong> <span id="detected-site" class="text-orange-600 dark:text-orange-400"></span>
            </div>
            
            <div id="extractor-details" class="text-sm text-gray-600 dark:text-gray-300">
              <div class="font-medium mb-2">Extraktor-Funktionen:</div>
              <div class="grid grid-cols-2 gap-2 text-xs">
                <div class="flex items-center space-x-2">
                  <span id="ingredient-groups-support" class="w-3 h-3 rounded-full bg-gray-400"></span>
                  <span>Zutatengruppen</span>
                </div>
                <div class="flex items-center space-x-2">
                  <span id="preparation-groups-support" class="w-3 h-3 rounded-full bg-gray-400"></span>
                  <span>Zubereitungsgruppen</span>
                </div>
                <div class="flex items-center space-x-2">
                  <span id="images-support" class="w-3 h-3 rounded-full bg-gray-400"></span>
                  <span>Bilder</span>
                </div>
                <div class="flex items-center space-x-2">
                  <span id="nutrition-support" class="w-3 h-3 rounded-full bg-gray-400"></span>
                  <span>Nährwerte</span>
                </div>
                <div class="flex items-center space-x-2">
                  <span id="metadata-support" class="w-3 h-3 rounded-full bg-gray-400"></span>
                  <span>Metadaten</span>
                </div>
                <div class="flex items-center space-x-2">
                  <span id="keywords-support" class="w-3 h-3 rounded-full bg-gray-400"></span>
                  <span>Keywords</span>
                </div>
                <div class="flex items-center space-x-2">
                  <span id="category-support" class="w-3 h-3 rounded-full bg-gray-400"></span>
                  <span>Kategorie</span>
                </div>
                <div class="flex items-center space-x-2">
                  <span id="difficulty-support" class="w-3 h-3 rounded-full bg-gray-400"></span>
                  <span>Schwierigkeit</span>
                </div>
                <div class="flex items-center space-x-2">
                  <span id="time-support" class="w-3 h-3 rounded-full bg-gray-400"></span>
                  <span>Zeit-Extraktion</span>
                </div>
              </div>
              <div id="extractor-description" class="mt-2 text-xs text-gray-500 dark:text-gray-400 italic"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="mt-6 flex justify-end space-x-3">
      <button id="cancel-import" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">Abbrechen</button>
      <button id="confirm-import" class="px-4 py-2 text-sm font-medium text-white bg-orange-500 border border-transparent rounded-md hover:bg-orange-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>Importieren</button>
    </div>
  </div>
</div>

<script>
  // Export functionality
  const exportBtn = document.getElementById('export-btn');
  const exportMenu = document.getElementById('export-menu');
  const exportJsonBtn = document.getElementById('export-json');
  const exportRcbBtn = document.getElementById('export-rcb');

  // Toggle export dropdown
  exportBtn?.addEventListener('click', (e) => {
    e.stopPropagation();
    exportMenu?.classList.toggle('hidden');
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', () => {
    exportMenu?.classList.add('hidden');
  });

  // Export handlers
  exportJsonBtn?.addEventListener('click', () => {
    window.location.href = '/api/recipe-export?format=json';
    exportMenu?.classList.add('hidden');
  });

  exportRcbBtn?.addEventListener('click', () => {
    window.location.href = '/api/recipe-export?format=rcb';
    exportMenu?.classList.add('hidden');
  });

  // Import functionality
  const importBtn = document.getElementById('import-btn');
  const importModal = document.getElementById('import-modal');
  const importFile = document.getElementById('import-file');
  const fileUpload = document.getElementById('file-upload');
  const cancelImport = document.getElementById('cancel-import');
  const confirmImport = document.getElementById('confirm-import');
  
  // Tab elements
  const importFileTab = document.getElementById('import-file-tab');
  const importUrlTab = document.getElementById('import-url-tab');
  const importFileContent = document.getElementById('import-file-content');
  const importUrlContent = document.getElementById('import-url-content');
  
  // URL elements
  const recipeUrl = document.getElementById('recipe-url') as HTMLInputElement;
  const urlPreview = document.getElementById('url-preview');
  const detectedSite = document.getElementById('detected-site');
  
  let selectedFile: File | null = null;
  let currentImportType: 'file' | 'url' = 'file';
  let supportedSites: any[] = [];

  // Load supported sites
  loadSupportedSites();

  importBtn?.addEventListener('click', () => {
    importModal?.classList.remove('hidden');
    setImportType('file');
  });

  cancelImport?.addEventListener('click', () => {
    importModal?.classList.add('hidden');
    resetImportModal();
  });

  // Tab switching
  importFileTab?.addEventListener('click', () => setImportType('file'));
  importUrlTab?.addEventListener('click', () => setImportType('url'));

  // File upload
  fileUpload?.addEventListener('change', (e) => {
    const target = e.target as HTMLInputElement;
    if (target.files && target.files[0]) {
      selectedFile = target.files[0];
      updateImportButton();
      updateFileDisplay();
    }
  });

  // URL input
  recipeUrl?.addEventListener('input', async (e) => {
    const target = e.target as HTMLInputElement;
    const url = target.value.trim();
    
    if (url) {
      await updateUrlPreview(url);
      updateImportButton();
    } else {
      hideUrlPreview();
      updateImportButton();
    }
  });

  confirmImport?.addEventListener('click', async () => {
    if (currentImportType === 'file') {
      await handleFileImport();
    } else {
      await handleUrlImport();
    }
  });

  function setImportType(type: 'file' | 'url') {
    currentImportType = type;
    
    if (type === 'file') {
      // Activate file tab
      importFileTab?.classList.add('text-gray-900', 'dark:text-white', 'bg-white', 'dark:bg-gray-800');
      importFileTab?.classList.remove('text-gray-500', 'dark:text-gray-400', 'bg-gray-50', 'dark:bg-gray-700');
      
      // Deactivate URL tab
      importUrlTab?.classList.add('text-gray-500', 'dark:text-gray-400', 'bg-gray-50', 'dark:bg-gray-700');
      importUrlTab?.classList.remove('text-gray-900', 'dark:text-white', 'bg-white', 'dark:bg-gray-800');
      
      importFileContent?.classList.remove('hidden');
      importUrlContent?.classList.add('hidden');
    } else {
      // Activate URL tab
      importUrlTab?.classList.add('text-gray-900', 'dark:text-white', 'bg-white', 'dark:bg-gray-800');
      importUrlTab?.classList.remove('text-gray-500', 'dark:text-gray-400', 'bg-gray-50', 'dark:bg-gray-700');
      
      // Deactivate file tab
      importFileTab?.classList.add('text-gray-500', 'dark:text-gray-400', 'bg-gray-50', 'dark:bg-gray-700');
      importFileTab?.classList.remove('text-gray-900', 'dark:text-white', 'bg-white', 'dark:bg-gray-800');
      
      importUrlContent?.classList.remove('hidden');
      importFileContent?.classList.add('hidden');
    }
    
    updateImportButton();
  }

  async function loadSupportedSites() {
    try {
      const response = await fetch('/api/recipe-import-url');
      if (response.ok) {
        const data = await response.json();
        supportedSites = data.supportedSites || [];
      }
    } catch (error) {
      console.error('Failed to load supported sites:', error);
    }
  }

  async function updateUrlPreview(url: string) {
    try {
      new URL(url); // Validate URL format first
      
      // Get extractor preview information
      const response = await fetch('/api/recipe-import-preview', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ url })
      });
      
      if (response.ok) {
        const data = await response.json();
        
        // Update extractor name
        if (detectedSite) {
          detectedSite.textContent = data.extractorName;
        }
        
        // Update capabilities
        updateCapabilityIndicator('ingredient-groups-support', data.capabilities.supportsIngredientGroups);
        updateCapabilityIndicator('preparation-groups-support', data.capabilities.supportsPreparationGroups);
        updateCapabilityIndicator('images-support', data.capabilities.supportsImages);
        updateCapabilityIndicator('nutrition-support', data.capabilities.supportsNutrition);
        updateCapabilityIndicator('metadata-support', data.capabilities.supportsMetadata);
        updateCapabilityIndicator('keywords-support', data.capabilities.supportsKeywordExtraction);
        updateCapabilityIndicator('category-support', data.capabilities.supportsCategoryExtraction);
        updateCapabilityIndicator('difficulty-support', data.capabilities.supportsDifficultyExtraction);
        updateCapabilityIndicator('time-support', data.capabilities.supportsTimeExtraction);
        
        // Update description
        const descriptionElement = document.getElementById('extractor-description');
        if (descriptionElement) {
          descriptionElement.textContent = data.capabilities.description;
        }
        
        urlPreview?.classList.remove('hidden');
      } else {
        // Fallback to simple domain detection
        const urlObj = new URL(url);
        const domain = urlObj.hostname.toLowerCase();
        
        const matchingSite = supportedSites.find(site => 
          site.domains.some((d: string) => 
            domain === d || domain.endsWith(`.${d}`) || domain.includes(d)
          )
        );
        
        if (detectedSite) {
          detectedSite.textContent = matchingSite ? matchingSite.name : 'Allgemeine Website (JSON-LD Fallback)';
        }
        
        // Set default capabilities for fallback
        updateCapabilityIndicator('ingredient-groups-support', false);
        updateCapabilityIndicator('preparation-groups-support', false);
        updateCapabilityIndicator('images-support', true);
        updateCapabilityIndicator('nutrition-support', false);
        updateCapabilityIndicator('metadata-support', true);
        updateCapabilityIndicator('keywords-support', true);
        updateCapabilityIndicator('category-support', true);
        updateCapabilityIndicator('difficulty-support', false);
        updateCapabilityIndicator('time-support', false);
        
        const descriptionElement = document.getElementById('extractor-description');
        if (descriptionElement) {
          descriptionElement.textContent = 'Basis-Funktionalität verfügbar';
        }
        
        urlPreview?.classList.remove('hidden');
      }
    } catch {
      hideUrlPreview();
    }
  }
  
  function updateCapabilityIndicator(elementId: string, isSupported: boolean | 'experimental') {
    const element = document.getElementById(elementId);
    if (element) {
      if (isSupported === 'experimental') {
        element.className = 'w-3 h-3 rounded-full bg-yellow-500';
      } else {
        element.className = `w-3 h-3 rounded-full ${
          isSupported 
            ? 'bg-green-500' 
            : 'bg-gray-400'
        }`;
      }
    }
  }

  function hideUrlPreview() {
    urlPreview?.classList.add('hidden');
  }

  async function handleFileImport() {
    if (!selectedFile) return;

    try {
      const formData = new FormData();
      formData.append('file', selectedFile);

      const response = await fetch('/api/recipe-import', {
        method: 'POST',
        body: formData
      });

      const result = await response.json();

      if (response.ok) {
        const imageInfo = result.totalImages ? ` (mit ${result.totalImages} Bild(ern))` : '';
        
        if (result.imported === 1 && result.recipeId) {
          // Single recipe imported - redirect to recipe page
          if (window.showSuccess) {
            await window.showSuccess(`Erfolgreich Rezept importiert${imageInfo}!`);
          }
          window.location.href = `/rezept/${result.recipeId}`;
        } else {
          // Multiple recipes imported - stay on recipe list
          if (window.showSuccess) {
            await window.showSuccess(`Erfolgreich ${result.imported} Rezept(e) importiert${imageInfo}!`);
          }
          window.location.reload();
        }
      } else {
        if (window.showError) {
          window.showError(`Import fehlgeschlagen: ${result.error}`);
        } else {
          alert(`Import fehlgeschlagen: ${result.error}`);
        }
      }
    } catch (error) {
      if (window.showError) {
        window.showError(`Import fehlgeschlagen: ${error}`);
      } else {
        alert(`Import fehlgeschlagen: ${error}`);
      }
    }

    importModal?.classList.add('hidden');
    resetImportModal();
  }

  async function handleUrlImport() {
    const url = recipeUrl?.value.trim();
    if (!url) return;

    // Show loading state
    if (confirmImport) {
      (confirmImport as HTMLButtonElement).disabled = true;
      (confirmImport as HTMLButtonElement).textContent = 'Importiere...';
    }

    try {
      const response = await fetch('/api/recipe-import-url', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ url })
      });

      const result = await response.json();

      if (response.ok) {
        // URL import always imports a single recipe - redirect to recipe page
        if (window.showSuccess) {
          await window.showSuccess(`Erfolgreich Rezept "${result.recipe.title}" importiert mit ${result.extractorUsed}!`);
        }
        window.location.href = `/rezept/${result.recipeId}`;
      } else {
        if (window.showError) {
          window.showError(`Import fehlgeschlagen: ${result.error}`);
        } else {
          alert(`Import fehlgeschlagen: ${result.error}`);
        }
      }
    } catch (error) {
      if (window.showError) {
        window.showError(`Import fehlgeschlagen: ${error}`);
      } else {
        alert(`Import fehlgeschlagen: ${error}`);
      }
    }

    // Reset loading state
    if (confirmImport) {
      (confirmImport as HTMLButtonElement).disabled = false;
      (confirmImport as HTMLButtonElement).textContent = 'Importieren';
    }

    importModal?.classList.add('hidden');
    resetImportModal();
  }

  function updateImportButton() {
    if (confirmImport) {
      const isValid = currentImportType === 'file' 
        ? !!selectedFile 
        : !!(recipeUrl?.value.trim());
      (confirmImport as HTMLButtonElement).disabled = !isValid;
    }
  }

  function resetImportModal() {
    selectedFile = null;
    if (recipeUrl) recipeUrl.value = '';
    hideUrlPreview();
    updateImportButton();
    resetFileDisplay();
  }

  function updateFileDisplay() {
    const content = document.getElementById('import-file-content');
    if (content && selectedFile) {
      content.innerHTML = `
        <div class="border-2 border-dashed border-green-300 dark:border-green-600 rounded-lg p-6 text-center bg-green-50 dark:bg-green-900/20">
          <svg class="mx-auto h-8 w-8 text-green-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
          <div class="text-sm font-medium text-gray-900 dark:text-white">${selectedFile.name}</div>
          <div class="text-xs text-gray-500 dark:text-gray-400">${(selectedFile.size / 1024).toFixed(1)} KB</div>
        </div>
      `;
    }
  }

  function resetFileDisplay() {
    const content = document.getElementById('import-file-content');
    if (content) {
      content.innerHTML = `
        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
          <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3-3m-3 3l3 3m-3-3H21" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <div class="mt-4">
            <label for="file-upload" class="cursor-pointer">
              <span class="mt-2 block text-sm font-medium text-gray-900">
                Datei auswählen oder hier ablegen
              </span>
              <span class="mt-1 block text-xs text-gray-500">
                JSON oder RCB Dateien (.json, .rcb)
              </span>
            </label>
            <input id="file-upload" name="file-upload" type="file" accept=".json,.rcb" class="sr-only">
          </div>
        </div>
      `;
      
      // Re-attach event listener
      const newFileUpload = document.getElementById('file-upload');
      newFileUpload?.addEventListener('change', (e) => {
        const target = e.target as HTMLInputElement;
        if (target.files && target.files[0]) {
          selectedFile = target.files[0];
          updateImportButton();
          updateFileDisplay();
        }
      });
    }
  }
</script> 