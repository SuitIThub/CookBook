---
import ImportModal from '../modals/ImportModal.astro';
import WarningModal from '../modals/WarningModal.astro';
import ShoppingListModal from '../modals/ShoppingListModal.astro';

interface Props {
  recipeCount: number;
}

const { recipeCount } = Astro.props;

// Note: showModal, showSuccess, showError, etc. are declared in Layout.astro
declare global {
  interface Window {
    openImportModal?: () => void;
    openShoppingListModal?: (selectedRecipes: Set<string>) => Promise<void>;
    createNewShoppingList?: () => Promise<void>;
  }
}
---

<style>
  .flex-between {
    @apply flex flex-col md:flex-row md:justify-between gap-4 md:gap-0;
  }
</style>

<div class="flex-between">
  <div>
    <h1 class="heading-primary">Meine Rezepte</h1>
    <p class="text-muted mt-1">
      <span id="recipe-count">{recipeCount}</span> Rezepte gefunden
      <span id="selected-count" class="hidden">
        (<span class="text-orange-600 dark:text-orange-400">0 ausgewählt</span>)
      </span>
    </p>
  </div>
  
  <!-- Bulk Actions -->
  <div id="bulk-actions" class="hidden flex flex-wrap gap-2">
    <button id="cancel-selection" class="btn btn-secondary flex items-center space-x-2 flex-1 md:flex-none justify-center">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
      <span>Auswahl beenden</span>
    </button>

    <button id="bulk-delete" class="btn btn-danger flex items-center space-x-2 flex-1 md:flex-none justify-center">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
      </svg>
      <span>Löschen</span>
    </button>
    
    <div class="relative flex-1 md:flex-none">
      <button id="bulk-export-btn" class="btn btn-secondary flex items-center space-x-2 w-full justify-center">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
        </svg>
        <span>Exportieren</span>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
        </svg>
      </button>
      <div id="bulk-export-menu" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg border border-gray-200 hidden z-10">
        <div class="py-1">
          <button id="bulk-export-json" class="flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            JSON (ohne Bilder)
          </button>
          <button id="bulk-export-rcb" class="flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
            </svg>
            Vollständig (mit Bildern)
          </button>
        </div>
      </div>
    </div>
    
    <button id="bulk-shopping-list" class="btn btn-secondary flex items-center space-x-2 flex-1 md:flex-none justify-center">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
      </svg>
      <span>Zur Einkaufsliste</span>
    </button>
  </div>

  <!-- Regular Actions -->
  <div id="regular-actions" class="flex flex-wrap gap-2">
    <!-- Selection Mode Button (Mobile) -->
    <button id="selection-mode-btn" class="btn btn-secondary flex items-center space-x-2 md:hidden flex-1 justify-center">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
      </svg>
      <span>Auswählen</span>
    </button>

    <!-- Random Recipe Button -->
    <button id="random-recipe-btn" class="btn btn-secondary flex items-center space-x-2 flex-1 md:flex-none justify-center">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
      </svg>
      <span>Zufälliges Rezept</span>
    </button>

    <!-- Create Recipe Button -->
    <button id="create-recipe-btn" class="btn btn-primary flex items-center space-x-2 flex-1 md:flex-none justify-center">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
      </svg>
      <span>Neues Rezept</span>
    </button>

    <!-- Import Button -->
    <button id="import-btn" class="btn btn-secondary flex items-center space-x-2 flex-1 md:flex-none justify-center">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
      </svg>
      <span>Importieren</span>
    </button>
    
    <!-- Export Dropdown -->
    <div class="relative flex-1 md:flex-none">
      <button id="export-btn" class="btn btn-secondary flex items-center space-x-2 w-full justify-center">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
        </svg>
        <span>Exportieren</span>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
        </svg>
      </button>
      <div id="export-menu" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg border border-gray-200 hidden z-10">
        <div class="py-1">
          <button id="export-json" class="flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            JSON (ohne Bilder)
          </button>
          <button id="export-rcb" class="flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
            </svg>
            Vollständig (mit Bildern)
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Hidden file input for import -->
<input type="file" id="import-file" accept=".json,.rcb" style="display: none;">

<ImportModal />
<WarningModal />
<ShoppingListModal />

<script>

  // Selection state
  let selectedRecipes = new Set();
  let isSelectionMode = false;
  
  // UI Elements
  const bulkActions = document.getElementById('bulk-actions');
  const regularActions = document.getElementById('regular-actions');
  const selectedCount = document.getElementById('selected-count');
  const selectedCountText = selectedCount?.querySelector('span');
  const cancelSelectionBtn = document.getElementById('cancel-selection');
  const selectionModeBtn = document.getElementById('selection-mode-btn');
  
  // Bulk action buttons
  const bulkDeleteBtn = document.getElementById('bulk-delete');
  const bulkExportBtn = document.getElementById('bulk-export-btn');
  const bulkExportMenu = document.getElementById('bulk-export-menu');
  const bulkExportJsonBtn = document.getElementById('bulk-export-json');
  const bulkExportRcbBtn = document.getElementById('bulk-export-rcb');
  const bulkShoppingListBtn = document.getElementById('bulk-shopping-list');
  
  // Toggle selection mode
  selectionModeBtn?.addEventListener('click', () => {
    isSelectionMode = true;
    document.querySelectorAll('.recipe-card').forEach(card => {
      card.classList.add('selection-mode');
    });
    updateUI();
  });

  // Handle checkbox clicks directly to ensure they work in selection mode
  // This must run before the card click handler to prevent interference
  document.addEventListener('click', (e) => {
    const checkbox = e.target as HTMLInputElement;
    if (!checkbox.classList.contains('recipe-select-checkbox')) return;
    
    // Stop propagation to prevent the card click handler from also handling this
    // The checkbox's native behavior will toggle it, and the change event will fire
    e.stopPropagation();
  });

  // Handle recipe card clicks in selection mode
  document.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    
    // Don't handle clicks on the checkbox itself - let the change event handle it
    if (target.classList.contains('recipe-select-checkbox') || 
        target.closest('.selection-indicator')) {
      return;
    }
    
    const recipeCard = target.closest('.recipe-card');
    if (!recipeCard || !isSelectionMode) return;

    const recipeId = recipeCard.getAttribute('data-recipe-id');
    if (!recipeId) return;

    const checkbox = recipeCard.querySelector<HTMLInputElement>('.recipe-select-checkbox');
    if (!checkbox) return;

    // Toggle checkbox
    checkbox.checked = !checkbox.checked;

    if (checkbox.checked) {
      selectedRecipes.add(recipeId);
      recipeCard.classList.add('selected');
    } else {
      selectedRecipes.delete(recipeId);
      recipeCard.classList.remove('selected');
    }

    updateUI();
  });

  // Update UI based on selection state
  function updateUI() {
    const count = selectedRecipes.size;
    
    // If no recipes are selected and we're in selection mode, exit selection mode
    if (count === 0 && isSelectionMode) {
      // Remove selection-mode class from all recipe cards
      document.querySelectorAll('.recipe-card').forEach(card => {
        card.classList.remove('selection-mode');
        card.classList.remove('selected');
      });
      
      // Clear selection mode flag
      isSelectionMode = false;
    }
    
    if (count > 0 || isSelectionMode) {
      bulkActions?.classList.remove('hidden');
      regularActions?.classList.add('hidden');
      selectedCount?.classList.remove('hidden');
      if (selectedCountText) {
        selectedCountText.textContent = `${count} ausgewählt`;
      }
    } else {
      bulkActions?.classList.add('hidden');
      regularActions?.classList.remove('hidden');
      selectedCount?.classList.add('hidden');
    }
  }

  // Cancel selection
  function cancelSelection() {
    // Uncheck all checkboxes
    document.querySelectorAll<HTMLInputElement>('.recipe-select-checkbox').forEach(checkbox => {
      checkbox.checked = false;
    });
    
    // Remove selected class from all recipe cards
    document.querySelectorAll('.recipe-card').forEach(card => {
      card.classList.remove('selected');
      card.classList.remove('selection-mode');
    });
    
    // Clear selection set and mode
    selectedRecipes.clear();
    isSelectionMode = false;
    
    // Update UI
    updateUI();
  }

  // Cancel selection button click
  cancelSelectionBtn?.addEventListener('click', cancelSelection);

  // Handle checkbox changes (for desktop)
  document.addEventListener('change', (e) => {
    const checkbox = e.target as HTMLInputElement;
    if (!checkbox.classList.contains('recipe-select-checkbox')) return;
    
    const recipeId = checkbox.dataset.recipeId;
    if (!recipeId) return;
    
    const recipeCard = document.querySelector(`.recipe-card[data-recipe-id="${recipeId}"]`);
    if (!recipeCard) return;
    
    if (checkbox.checked) {
      selectedRecipes.add(recipeId);
      recipeCard.classList.add('selected');
      if (!isSelectionMode) {
        isSelectionMode = true;
        document.querySelectorAll('.recipe-card').forEach(card => {
          card.classList.add('selection-mode');
        });
      }
    } else {
      selectedRecipes.delete(recipeId);
      recipeCard.classList.remove('selected');
    }
    
    updateUI();
  });
  
  // Bulk delete
  bulkDeleteBtn?.addEventListener('click', async () => {
    if (selectedRecipes.size === 0) return;
    
    const confirmed = window.showDeleteConfirm ? await window.showDeleteConfirm(
      `Möchten Sie wirklich ${selectedRecipes.size} Rezept${selectedRecipes.size === 1 ? '' : 'e'} löschen?`
    ) : false;
    
    if (!confirmed) return;
    
    try {
      const response = await fetch('/api/recipes', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids: Array.from(selectedRecipes) })
      });
      
      if (!response.ok) throw new Error('Fehler beim Löschen der Rezepte');
      
      window.location.reload();
    } catch (error) {
      console.error('Fehler beim Löschen:', error);
      if (window.showError) {
        window.showError('Die Rezepte konnten nicht gelöscht werden.');
      }
    }
  });
  
  // Bulk export
  bulkExportBtn?.addEventListener('click', (e) => {
    e.stopPropagation();
    bulkExportMenu?.classList.toggle('hidden');
  });
  
  document.addEventListener('click', () => {
    bulkExportMenu?.classList.add('hidden');
  });
  
  bulkExportJsonBtn?.addEventListener('click', () => {
    if (selectedRecipes.size === 0) return;
    window.location.href = `/api/recipes/export?format=json&ids=${Array.from(selectedRecipes).join(',')}`;
    bulkExportMenu?.classList.add('hidden');
  });
  
  bulkExportRcbBtn?.addEventListener('click', () => {
    if (selectedRecipes.size === 0) return;
    window.location.href = `/api/recipes/export?format=rcb&ids=${Array.from(selectedRecipes).join(',')}`;
    bulkExportMenu?.classList.add('hidden');
  });
  
  // Shopping List Modal
  // NOTE: createNewShoppingList is now handled by ShoppingListModal component
  // Do not define it here to avoid conflicts

  // Show shopping list modal
  bulkShoppingListBtn?.addEventListener('click', async () => {
    if (selectedRecipes.size === 0) return;
    
    // Create a fresh Set from checked boxes to ensure we're passing the right data
    const checkedBoxes = document.querySelectorAll<HTMLInputElement>('.recipe-select-checkbox:checked');
    const checkedRecipeIds = Array.from(checkedBoxes)
      .map(cb => cb.dataset.recipeId)
      .filter((id): id is string => Boolean(id));
    
    const verifiedSelectedRecipes = new Set<string>(checkedRecipeIds);
    
    if (window.openShoppingListModal) {
      await window.openShoppingListModal(verifiedSelectedRecipes);
    }
  });

  // Import functionality - moved to ImportModal component
  const importBtn = document.getElementById('import-btn');
  importBtn?.addEventListener('click', () => {
    if (window.openImportModal) {
      window.openImportModal();
    }
  });

  // Export functionality
  const exportBtn = document.getElementById('export-btn');
  const exportMenu = document.getElementById('export-menu');
  const exportJsonBtn = document.getElementById('export-json');
  const exportRcbBtn = document.getElementById('export-rcb');

  // Toggle export dropdown
  exportBtn?.addEventListener('click', (e) => {
    e.stopPropagation();
    exportMenu?.classList.toggle('hidden');
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', () => {
    exportMenu?.classList.add('hidden');
  });

  // Export handlers
  exportJsonBtn?.addEventListener('click', () => {
    window.location.href = '/api/recipes/export?format=json';
    exportMenu?.classList.add('hidden');
  });

  exportRcbBtn?.addEventListener('click', () => {
    window.location.href = '/api/recipes/export?format=rcb';
    exportMenu?.classList.add('hidden');
  });
</script>